<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Bawaslu Riau</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sembunyikan elemen yang tidak perlu di awal */
        #canvas, #imgPreview, #retakeButton {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="flex items-center justify-center min-h-screen py-10 px-4">
        <div class="w-full max-w-lg bg-white p-8 rounded-xl shadow-lg">
            
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">
                Selamat Datang!
            </h1>
            <p class="text-center text-gray-600 mb-6">
                Aplikasi Absensi Bawaslu Provinsi Riau
            </p>

            <form id="absensiForm">
                <!-- Pilihan Kabupaten -->
                <div class="mb-4">
                    <label for="kabupaten" class="block text-sm font-medium text-gray-700 mb-1">Kabupaten/Kota</label>
                    <select id="kabupaten" name="kabupaten" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Pilih Kabupaten/Kota --</option>
                        <option value="Pekanbaru">Pekanbaru</option>
                        <option value="Dumai">Dumai</option>
                        <option value="Kuansing">Kuansing</option>
                        <option value="Rokan Hulu">Rokan Hulu</option>
                        <option value="Rokan Hilir">Rokan Hilir</option>
                        <option value="Indragiri Hulu">Indragiri Hulu</option>
                        <option value="Indragiri Hilir">Indragiri Hilir</option>
                        <option value="Kampar">Kampar</option>
                        <option value="Siak">Siak</option>
                        <option value="Bengkalis">Bengkalis</option>
                        <option value="Kep. Meranti">Kep. Meranti</option>
                        <option value="Pelalawan">Pelalawan</option>
                    </select>
                </div>

                <!-- Pilihan Pimpinan -->
                <div class="mb-4">
                    <label for="pimpinan" class="block text-sm font-medium text-gray-700 mb-1">Nama Pimpinan</label>
                    <select id="pimpinan" name="pimpinan" required disabled class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 focus:outline-none">
                        <option value="">-- Pilih Kabupaten Dulu --</option>
                    </select>
                </div>

                <!-- Jenis Presensi -->
                <div class="mb-4">
                    <label for="jenisPresensi" class="block text-sm font-medium text-gray-700 mb-1">Jenis Presensi</label>
                    <select id="jenisPresensi" name="jenisPresensi" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="Presensi Masuk">Presensi Masuk</option>
                        <option value="Presensi Pulang">Presensi Pulang</option>
                    </select>
                </div>

                <!-- Fitur Kamera -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Foto Selfie</label>
                    <div class="w-full bg-gray-200 rounded-md overflow-hidden">
                        <!-- Video stream dari kamera -->
                        <video id="video" class="w-full h-auto" playsinline autoplay muted></video>
                        <!-- Canvas untuk mengambil snapshot (tersembunyi) -->
                        <canvas id="canvas"></canvas>
                        <!-- Preview gambar yang diambil -->
                        <img id="imgPreview" class="w-full h-auto" alt="Preview Foto">
                    </div>
                    <!-- Tombol untuk kontrol kamera -->
                    <div class="flex gap-2 mt-2">
                         <button type="button" id="takePhotoButton" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">
                            Ambil Foto
                        </button>
                         <button type="button" id="retakeButton" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 transition duration-300">
                            Ulangi Foto
                        </button>
                    </div>
                    <!-- Data foto (tersembunyi) -->
                    <input type="hidden" id="fotoBase64" name="fotoBase64">
                </div>

                <!-- Tombol Kirim -->
                <button type="submit" id="submitButton" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 transition duration-300 disabled:bg-gray-400">
                    Kirim Absensi
                </button>
            </form>

            <!-- Area Notifikasi -->
            <div id="messageArea" class="mt-4 text-center"></div>

        </div>
    </div>

    <script>
        // --- PASTE URL WEB APP ANDA DI SINI ---
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzVLs6FEPkVVLEVAANKKasHVUOnW2G86A6p8hFIB6y9DgDt0uqQ2Hi7nayCjJ8Xo65bA/exec"; 
        // -------------------------------------

        // Data Pimpinan
        const pimpinanData = {
            "Pekanbaru": ["Ferdy", "Misbah Ibrahim", "Reni Purba", "Raja Inal Dalimunthe", "Taufik Hidayat"],
            "Dumai": ["Agustri", "Yosi Renaldi", "Yeni Kartini"],
            "Kuansing": ["Ade Indra Sakti", "Nur Afni", "Mardius Adi Saputra"],
            "Rokan Hulu": ["Fajrul Islami Damsir", "Gummer Siregar", "Yurnalis", "Wikki Yuliandra", "Safrizal Hasbi"],
            "Rokan Hilir": ["Zubaidah", "Jaka Abdillah", "Nasrudin", "Dedi Sibuae", "Nurmaidani"],
            "Indragiri Hulu": ["Dedi Risanto", "Dwi Apriansyah Indra", "M.Lukman Said", "Said M Affandi", "Salestia Deni"],
            "Indragiri Hilir": ["Rustam", "Rahmaddian", "Abus Siraj", "Indra", "Musdalifa"],
            "Kampar": ["Syawir Abdullah", "Miki AB", "Mustaqim Akbar", "Fadriansyah", "Mhd. Amin S"],
            "Siak": ["Zulfadli Nugraha", "Ahmad Dardiri", "Harlen Manurung", "M.Andi Susilawan", "Ikhsan Parulian Harap"],
            "Bengkalis": ["Usman", "Budi Kurnialis", "Andi Setiawan", "Arsi Suprianto", "Mendra"],
            "Kep. Meranti": ["Syamsurizal", "Rio Andika", "M. Hafit"],
            "Pelalawan": ["Andrizal", "Bambang Sugi Hartono", "Syakir Hamdani", "Ari Nugroho Susanto", "Ruda Nur Kisawan"]
        };

        // Data Koordinat Kantor
        const koordinatData = {
            "Pekanbaru": { lat: 0.5228952, lon: 101.4429202 },
            "Dumai": { lat: 1.6630254508232711, lon: 101.45249334765391 },
            "Kuansing": { lat: -0.534470, lon: 101.569874 },
            "Rokan Hulu": { lat: 0.876158, lon: 100.286686 },
            "Rokan Hilir": { lat: 2.158803, lon: 100.799874 },
            "Indragiri Hulu": { lat: 2.158803, lon: 100.799874 }, // Data InHu sama dengan Rohil di prompt
            "Indragiri Hilir": { lat: -0.3201440, lon: 103.1542940 },
            "Kampar": { lat: 0.324784, lon: 101.026305 },
            "Siak": { lat: 0.814464, lon: 102.018998 },
            "Bengkalis": { lat: 1.473969, lon: 102.123841 },
            "Kep. Meranti": { lat: 1.008499, lon: 102.712468 },
            "Pelalawan": { lat: 2.158803, lon: 100.799874 } // Data Pelalawan sama dengan Rohil di prompt
        };

        // Elemen DOM
        const kabupatenSelect = document.getElementById('kabupaten');
        const pimpinanSelect = document.getElementById('pimpinan');
        const form = document.getElementById('absensiForm');
        const submitButton = document.getElementById('submitButton');
        const messageArea = document.getElementById('messageArea');
        
        // Elemen Kamera
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const imgPreview = document.getElementById('imgPreview');
        const fotoBase64Input = document.getElementById('fotoBase64');
        const takePhotoButton = document.getElementById('takePhotoButton');
        const retakeButton = document.getElementById('retakeButton');
        let stream;

        // --- LOGIKA APLIKASI ---

        // 1. Inisialisasi Dropdown Kabupaten
        kabupatenSelect.addEventListener('change', () => {
            const selectedKabupaten = kabupatenSelect.value;
            pimpinanSelect.innerHTML = '<option value="">-- Memuat... --</option>'; // Clear
            
            if (selectedKabupaten && pimpinanData[selectedKabupaten]) {
                pimpinanSelect.disabled = false;
                pimpinanSelect.classList.remove('bg-gray-100');
                pimpinanSelect.innerHTML = '<option value="">-- Pilih Pimpinan --</option>'; // Reset
                pimpinanData[selectedKabupaten].forEach(nama => {
                    const option = document.createElement('option');
                    option.value = nama;
                    option.textContent = nama;
                    pimpinanSelect.appendChild(option);
                });
            } else {
                pimpinanSelect.disabled = true;
                pimpinanSelect.classList.add('bg-gray-100');
                pimpinanSelect.innerHTML = '<option value="">-- Pilih Kabupaten Dulu --</option>';
            }
        });

        // 2. Inisialisasi Kamera
        async function initCamera() {
            let constraints = { 
                video: { facingMode: 'user' },
                audio: false 
            };

            try {
                // Coba kamera depan (selfie) dulu
                stream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (err) {
                console.warn("Gagal mendapatkan kamera depan ('user'), mencoba kamera utama:", err);
                // Jika gagal (misal di PC/laptop), coba kamera apa saja
                constraints = { 
                    video: true, // Minta kamera apa saja yang tersedia
                    audio: false 
                };
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (finalErr) {
                    // --- PERUBAHAN DI SINI ---
                    // Mengganti console.error menjadi console.warn
                    // Ini BUKAN error, ini log bahwa error 'kamera tidak ada' telah ditangani.
                    console.warn("Peringatan akses kamera (ditangani):", finalErr); 
                    // --- AKHIR PERUBAHAN ---
                    
                    let errMsg = "Gagal mengakses kamera. Pastikan Anda memberikan izin.";
                    
                    const errName = finalErr.name || "";
                    const errMsgLower = (finalErr.message || "").toLowerCase();

                    if (errName === "NotFoundError" || 
                        errName === "DevicesNotFoundError" || 
                        errName === "OverconstrainedError" || 
                        errMsgLower.includes("not found") || 
                        errMsgLower.includes("no device") ||
                        errMsgLower.includes("requested device not found")) {
                        errMsg = "Error: Tidak ada kamera yang ditemukan di perangkat ini.";
                    } else if (errName === "NotAllowedError" || errName === "PermissionDeniedError") {
                        errMsg = "Error: Izin menggunakan kamera ditolak.";
                    }

                    showMessage(errMsg, "error");
                    return; // Hentikan eksekusi jika kamera gagal total
                }
            }

            // Jika stream berhasil didapat (dari salah satu try)
            video.srcObject = stream;
            video.style.display = 'block';
            takePhotoButton.style.display = 'block';
            imgPreview.style.display = 'none';
            retakeButton.style.display = 'none';
            fotoBase64Input.value = '';
        }
        
        // Panggil initCamera saat halaman dimuat
        window.addEventListener('load', initCamera);

        // 3. Logika Ambil Foto
        takePhotoButton.addEventListener('click', () => {
            // Pastikan video sudah memuat metadata sebelum mengambil gambar
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                console.warn("Video stream belum siap. Coba lagi sebentar.");
                showMessage("Kamera belum siap, coba lagi dalam 1 detik.", "loading");
                // Coba lagi setelah sedikit delay
                setTimeout(() => {
                    if (video.videoWidth === 0 || video.videoHeight === 0) {
                         console.error("Video stream gagal dimuat.");
                         showMessage("Gagal mengambil gambar, video stream tidak valid.", "error");
                         return;
                    }
                    // Panggil ulang fungsi klik jika sudah siap
                    takePhotoButton.click();
                }, 1000);
                return;
            }

            // Atur ukuran canvas sesuai video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Gambar frame video ke canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Dapatkan data Base64
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9); // Kompresi 90%
            imgPreview.src = dataUrl;
            fotoBase64Input.value = dataUrl; // Simpan Base64
            
            // Tampilkan preview, sembunyikan video
            video.style.display = 'none';
            imgPreview.style.display = 'block';
            takePhotoButton.style.display = 'none';
            retakeButton.style.display = 'block';
            
            // Hentikan stream kamera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // 4. Logika Ulangi Foto
        retakeButton.addEventListener('click', initCamera);

        // 5. Logika Submit Formulir
        form.addEventListener('submit', (e) => {
            e.preventDefault(); // Mencegah submit standar
            
            // Validasi Foto
            if (!fotoBase64Input.value) {
                showMessage("Harap ambil foto selfie terlebih dahulu.", "error");
                return;
            }

            // Validasi URL
            if (APPS_SCRIPT_URL === "URL_WEB_APP_ANDA" || APPS_SCRIPT_URL.length < 50) { // Pengecekan sederhana
                 showMessage("Error: URL Apps Script belum diatur dengan benar di index.html.", "error");
                 return;
            }

            setLoading(true, "Memeriksa lokasi dan data...");

            const formData = {
                kabupaten: kabupatenSelect.value,
                pimpinan: pimpinanSelect.value,
                jenisPresensi: document.getElementById('jenisPresensi').value,
            };

            // Cek Anti-Fraud
            const today = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD
            const fraudKey = `absensi_${today}_${formData.pimpinan}_${formData.jenisPresensi}`;
            
            if (localStorage.getItem(fraudKey)) {
                showMessage("Anda terdeteksi melakukan absensi berulang pada perangkat yang sama.", "error");
                setLoading(false);
                return;
            }

            // Jika lolos, lanjut ke pengecekan GPS
            getLocationAndSubmit(formData, fraudKey);
        });

        // 6. Mendapatkan Lokasi GPS
        function getLocationAndSubmit(formData, fraudKey) {
            if (!navigator.geolocation) {
                showMessage("Geolocation tidak didukung oleh browser Anda.", "error");
                setLoading(false);
                return;
            }

            setLoading(true, "Mendapatkan titik koordinat GPS...");

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Sukses dapat lokasi
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    
                    const target = koordinatData[formData.kabupaten];
                    if (!target) {
                        showMessage("Data koordinat untuk kabupaten Anda tidak ditemukan.", "error");
                        setLoading(false);
                        return;
                    }

                    // Hitung jarak
                    const distance = calculateDistance(userLat, userLon, target.lat, target.lon);

                    if (distance > 100) {
                        // Terlalu Jauh
                        const distanceMsg = `Anda saat ini tidak dapat melakukan absensi karena berada ${distance.toFixed(0)} meter dari titik lokasi kantor.`;
                        showMessage(distanceMsg, "error");
                        setLoading(false);
                    } else {
                        // LOKASI OK, KIRIM DATA
                        setLoading(true, "Lokasi terverifikasi. Mengirim data absensi...");
                        sendDataToAppsScript(formData, fraudKey);
                    }
                },
                (error) => {
                    // Gagal dapat lokasi
                    let errorMsg = "Gagal mendapatkan lokasi GPS. ";
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += "Anda menolak izin lokasi.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += "Informasi lokasi tidak tersedia.";
                            break;
                        case error.TIMEOUT:
                            errorMsg += "Waktu permintaan lokasi habis.";
                            break;
                        default:
                            errorMsg += "Terjadi error tidak diketahui.";
                    }
                    showMessage(errorMsg, "error");
                    setLoading(false);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 } // Opsi GPS Akurasi Tinggi
            );
        }

        // 7. Fungsi Perhitungan Jarak (Haversine Formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radius bumi dalam meter
            const p1 = lat1 * Math.PI / 180;
            const p2 = lat2 * Math.PI / 180;
            const deltaP = p2 - p1;
            const deltaL = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(deltaP / 2) * Math.sin(deltaP / 2) +
                      Math.cos(p1) * Math.cos(p2) *
                      Math.sin(deltaL / 2) * Math.sin(deltaL / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Jarak dalam meter
            return d;
        }

        // 8. Kirim Data ke Google Apps Script
        async function sendDataToAppsScript(formData, fraudKey) {
            const payload = {
                kabupaten: formData.kabupaten,
                nama: formData.pimpinan,
                jenisPresensi: formData.jenisPresensi,
                // Kirim hanya data base64-nya, buang headernya
                fotoBase64: fotoBase64Input.value.split(',')[1] 
            };

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', // Diperlukan untuk request cross-origin
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Kirim sebagai text/plain
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.status === "success") {
                    // Set flag anti-fraud di localStorage
                    localStorage.setItem(fraudKey, 'true');
                    
                    const tgl = new Date().toLocaleDateString('id-ID', { dateStyle: 'long' });
                    const successMsg = `Absensi '${formData.jenisPresensi}' atas nama '${formData.nama}' pada '${tgl}' telah dikirim. ${result.message || ''}`;
                    showMessage(successMsg, "success");
                    
                    // Reset form
                    form.reset();
                    pimpinanSelect.disabled = true;
                    pimpinanSelect.innerHTML = '<option value="">-- Pilih Kabupaten Dulu --</option>';
                    initCamera(); // Nyalakan kamera lagi
                } else {
                    // Error dari server
                    showMessage(`Error: ${result.message}`, "error");
                }

            } catch (error) { 
                console.error("Error sending data:", error);
                showMessage("Gagal terhubung ke server. Periksa koneksi internet Anda.", "error");
            } finally {
                setLoading(false);
            }
        }

        // 9. Helper UI
        function setLoading(isLoading, message = "") {
            submitButton.disabled = isLoading;
            if (isLoading) {
                submitButton.textContent = "Memproses...";
                showMessage(message, "loading");
            } else {
                submitButton.textContent = "Kirim Absensi";
            }
        }

        function showMessage(message, type) {
            messageArea.innerHTML = message;
            messageArea.className = 'mt-4 text-center p-3 rounded-md text-sm';
            
            switch (type) {
                case "success":
                    messageArea.classList.add('bg-green-100', 'text-green-800');
                    break;
                case "error":
                    messageArea.classList.add('bg-red-100', 'text-red-800');
                    break;
                case "loading":
                    messageArea.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                default:
                    messageArea.classList.add('bg-gray-100', 'text-gray-800');
            }
        }

    </script>
</body>
</html>

