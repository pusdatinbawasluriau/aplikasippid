<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Bawaslu Riau</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sembunyikan canvas */
        #canvas {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto max-w-lg p-5">
        
        <header class="text-center my-6">
            <h1 class="text-3xl font-bold text-gray-800">
                Selamat Datang di Aplikasi Absensi Bawaslu Provinsi Riauv2
            </h1>
        </header>

        <main class="bg-white rounded-lg shadow-xl p-6 md:p-8">
            <form id="absensiForm">
                
                <!-- Pilihan Kabupaten -->
                <div class="mb-4">
                    <label for="kabupaten" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kabupaten/Kota</label>
                    <select id="kabupaten" name="kabupaten" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Pilih --</option>
                        <option value="Pekanbaru">Pekanbaru</option>
                        <option value="Dumai">Dumai</option>
                        <option value="Kuansing">Kuansing</option>
                        <option value="Rokan Hulu">Rokan Hulu</option>
                        <option value="Rokan Hilir">Rokan Hilir</option>
                        <option value="Indragiri Hulu">Indragiri Hulu</option>
                        <option value="Indragiri Hilir">Indragiri Hilir</option>
                        <option value="Kampar">Kampar</option>
                        <option value="Siak">Siak</option>
                        <option value="Bengkalis">Bengkalis</option>
                        <option value="Kep. Meranti">Kep. Meranti</option>
                        <option value="Pelalawan">Pelalawan</option>
                    </select>
                </div>

                <!-- Pilihan Nama Pimpinan -->
                <div class="mb-4">
                    <label for="nama" class="block text-sm font-medium text-gray-700 mb-2">Nama Pimpinan</label>
                    <select id="nama" name="nama" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100" disabled>
                        <option value="">-- Pilih Kabupaten Dahulu --</option>
                    </select>
                </div>

                <!-- Pilihan Presensi -->
                <div class="mb-6">
                    <label for="jenisPresensi" class="block text-sm font-medium text-gray-700 mb-2">Jenis Presensi</label>
                    <select id="jenisPresensi" name="jenisPresensi" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Pilih Jenis Presensi --</option>
                        <option value="Presensi Masuk">Presensi Masuk</option>
                        <option value="Presensi Pulang">Presensi Pulang</option>
                    </select>
                </div>

                <!-- Kamera Selfie -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Foto Selfie</label>
                    <div id="cameraError" class="hidden text-red-500 text-sm mb-2">
                        Gagal mengakses kamera. Pastikan Anda memberikan izin kamera pada browser.
                    </div>
                    <!-- Video stream -->
                    <video id="video" autoplay playsinline class="w-full h-auto bg-gray-200 rounded-lg shadow-inner"></video>
                    
                    <!-- Tombol ambil foto -->
                    <button type="button" id="ambilFoto" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 mt-2">
                        Ambil Foto
                    </button>
                    
                    <!-- Preview foto -->
                    <div class="mt-4 text-center">
                        <span class="text-sm text-gray-600">Preview Foto:</span>
                        <img id="preview" class="w-1/2 mx-auto mt-2 rounded-lg shadow-md hidden"/>
                        <!-- Canvas untuk mengambil gambar (tersembunyi) -->
                        <canvas id="canvas"></canvas>
                        <!-- Input tersembunyi untuk menyimpan data base64 -->
                        <input type="hidden" id="imageBase64" name="imageBase64" required>
                    </div>
                </div>

                <!-- Tombol Kirim -->
                <div class="mt-8">
                    <button type="submit" id="kirimAbsensi"
                        class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-300 flex items-center justify-center">
                        <span id="submitText">Kirim Absensi</span>
                        <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>

            </form>

            <!-- Notifikasi -->
            <div id="message" class="mt-6 text-center text-sm"></div>

        </main>
    </div>

    <script>
        // --- KONFIGURASI PENTING ---
        // GANTI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwBnlWxaiNLJgfnbLv87zoUcGUPCRscPmszyq2K6At7pQyw3zidiaAPUIyIxt7dzAJ0/exec';
        // --- BATAS KONFIGURASI ---

        // Data Pimpinan
        const pimpinanData = {
            'Pekanbaru': ['Ferdy', 'Misbah Ibrahim', 'Reni Purba', 'Raja Inal Dalimunthe', 'Taufik Hidayat'],
            'Dumai': ['Agustri', 'Yosi Renaldi', 'Yeni Kartini'],
            'Kuansing': ['Ade Indra Sakti', 'Nur Afni', 'Mardius Adi Saputra'],
            'Rokan Hulu': ['Fajrul Islami Damsir', 'Gummer Siregar', 'Yurnalis', 'Wikki Yuliandra', 'Safrizal Hasbi'],
            'Rokan Hilir': ['Zubaidah', 'Jaka Abdillah', 'Nasrudin', 'Dedi Sibuae', 'Nurmaidani'],
            'Indragiri Hulu': ['Dedi Risanto', 'Dwi Apriansyah Indra', 'M.Lukman Said', 'Said M Affandi', 'Salestia Deni'],
            'Indragiri Hilir': ['Rustam', 'Rahmaddian', 'Abus Siraj', 'Indra', 'Musdalifa'],
            'Kampar': ['Syawir Abdullah', 'Miki AB', 'Mustaqim Akbar', 'Fadriansyah', 'Mhd. Amin S'],
            'Siak': ['Zulfadli Nugraha', 'Ahmad Dardiri', 'Harlen Manurung', 'M.Andi Susilawan', 'Ikhsan Parulian Harap'],
            'Bengkalis': ['Usman', 'Budi Kurnialis', 'Andi Setiawan', 'Arsi Suprianto', 'Mendra'],
            'Kep. Meranti': ['Syamsurizal', 'Rio Andika', 'M. Hafit'],
            'Pelalawan': ['Andrizal', 'Bambang Sugi Hartono', 'Syakir Hamdani', 'Ari Nugroho Susanto', 'Ruda Nur Kisawan']
        };

        // Data Koordinat
        const koordinatData = {
            'Pekanbaru': { lat: 0.5228952, lon: 101.4429202 },
            'Dumai': { lat: 1.6630254508232711, lon: 101.45249334765391 },
            'Kuansing': { lat: -0.534470, lon: 101.569874 },
            'Rokan Hulu': { lat: 0.876158, lon: 100.286686 },
            'Rokan Hilir': { lat: 2.158803, lon: 100.799874 },
            'Indragiri Hulu': { lat: 2.158803, lon: 100.799874 }, // Data sama dengan Rohil? Sesuai permintaan
            'Indragiri Hilir': { lat: -0.3201440, lon: 103.1542940 },
            'Kampar': { lat: 0.324784, lon: 101.026305 },
            'Siak': { lat: 0.814464, lon: 102.018998 },
            'Bengkalis': { lat: 1.473969, lon: 102.123841 },
            'Kep. Meranti': { lat: 1.008499, lon: 102.712468 },
            'Pelalawan': { lat: 2.158803, lon: 100.799874 } // Data sama dengan Rohil? Sesuai permintaan
        };

        // Elemen DOM
        const kabupatenSelect = document.getElementById('kabupaten');
        const namaSelect = document.getElementById('nama');
        const form = document.getElementById('absensiForm');
        const messageDiv = document.getElementById('message');
        const submitButton = document.getElementById('kirimAbsensi');
        const submitText = document.getElementById('submitText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // Elemen Kamera
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ambilFotoButton = document.getElementById('ambilFoto');
        const preview = document.getElementById('preview');
        const imageBase64Input = document.getElementById('imageBase64');
        const cameraErrorDiv = document.getElementById('cameraError');

        // 1. Inisialisasi Kamera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }, // Paksa kamera depan
                    audio: false 
                });
                video.srcObject = stream;
                cameraErrorDiv.classList.add('hidden');
            } catch (err) {
                console.error("Error mengakses kamera:", err);
                cameraErrorDiv.classList.remove('hidden');
                ambilFotoButton.disabled = true;
            }
        }
        
        // 2. Ambil Foto
        ambilFotoButton.addEventListener('click', () => {
            // Set ukuran canvas sesuai video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Gambar frame video ke canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Dapatkan data Base64
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9); // Kualitas 90%
            
            // Tampilkan preview
            preview.src = dataUrl;
            preview.classList.remove('hidden');
            
            // Simpan ke input tersembunyi
            imageBase64Input.value = dataUrl;
        });

        // 3. Update Dropdown Pimpinan
        kabupatenSelect.addEventListener('change', (e) => {
            const selectedKabupaten = e.target.value;
            
            // Kosongkan dan nonaktifkan dulu
            namaSelect.innerHTML = '<option value="">-- Pilih --</option>';
            namaSelect.disabled = true;
            namaSelect.classList.add('bg-gray-100');

            if (selectedKabupaten && pimpinanData[selectedKabupaten]) {
                const pimpinanList = pimpinanData[selectedKabupaten];
                pimpinanList.forEach(nama => {
                    const option = document.createElement('option');
                    option.value = nama;
                    option.textContent = nama;
                    namaSelect.appendChild(option);
                });
                // Aktifkan
                namaSelect.disabled = false;
                namaSelect.classList.remove('bg-gray-100');
            } else if (selectedKabupaten) {
                 namaSelect.innerHTML = '<option value="">-- Data Pimpinan Tidak Ditemukan --</option>';
            }
        });

        // 4. Handle Submit Form
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            setLoading(true, 'Mengirim data...');

            const formData = new FormData(form);
            const data = {
                kabupaten: formData.get('kabupaten'),
                nama: formData.get('nama'),
                jenisPresensi: formData.get('jenisPresensi'),
                imageBase64: formData.get('imageBase64')
            };

            // Validasi foto
            if (!data.imageBase64) {
                showMessage('error', 'Anda harus mengambil foto selfie terlebih dahulu.');
                setLoading(false);
                return;
            }

            // 4a. Cek Anti-Fraud (localStorage)
            const today = new Date().toISOString().split('T')[0];
            const fraudKey = `absensi_${today}_${data.jenisPresensi}_${data.nama}`;
            
            if (localStorage.getItem(fraudKey)) {
                showMessage('error', 'Anda terdeteksi melakukan absensi berulang pada perangkat yang sama untuk jenis presensi ini.');
                setLoading(false);
                return;
            }

            // 4b. Cek Lokasi GPS
            showMessage('info', 'Mendapatkan lokasi GPS Anda...');
            if (!navigator.geolocation) {
                showMessage('error', 'Browser Anda tidak mendukung Geolocation.');
                setLoading(false);
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Berhasil dapat lokasi
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    
                    const target = koordinatData[data.kabupaten];
                    if (!target) {
                        showMessage('error', 'Data koordinat untuk kabupaten Anda tidak ditemukan.');
                        setLoading(false);
                        return;
                    }

                    const distance = haversineDistance(userLat, userLon, target.lat, target.lon);

                    if (distance > 100) { // Jarak dalam meter
                        showMessage('error', `Anda saat ini tidak dapat melakukan absensi karena berada ${distance.toFixed(0)} meter dari titik lokasi kantor.`);
                        setLoading(false);
                        return;
                    }

                    // 4c. Kirim Data ke Google Apps Script
                    showMessage('info', 'Lokasi terverifikasi. Mengirim data absensi...');
                    
                    fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'cors', // Penting untuk cross-origin request
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.status === 'success') {
                            showMessage('success', result.message);
                            // Set flag anti-fraud
                            localStorage.setItem(fraudKey, 'true');
                            // Reset form
                            form.reset();
                            preview.classList.add('hidden');
                            preview.src = '';
                            imageBase64Input.value = '';
                            namaSelect.innerHTML = '<option value="">-- Pilih Kabupaten Dahulu --</option>';
                            namaSelect.disabled = true;
                            namaSelect.classList.add('bg-gray-100');
                        } else {
                            showMessage('error', `Gagal mengirim: ${result.message}`);
                        }
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error('Error fetching:', err);
                        showMessage('error', 'Terjadi kesalahan jaringan. Coba lagi.');
                        setLoading(false);
                    });

                },
                (error) => {
                    // Gagal dapat lokasi
                    let errorMsg = 'Gagal mendapatkan lokasi GPS. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += "Pastikan Anda memberikan izin lokasi.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += "Informasi lokasi tidak tersedia.";
                            break;
                        case error.TIMEOUT:
                            errorMsg += "Waktu permintaan lokasi habis.";
                            break;
                        default:
                            errorMsg += "Terjadi kesalahan tidak diketahui.";
                            break;
                    }
                    showMessage('error', errorMsg);
                    setLoading(false);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } // Opsi GPS
            );
        });

        // 5. Fungsi Helper
        
        function setLoading(isLoading, message = '') {
            if (isLoading) {
                submitButton.disabled = true;
                submitText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                showMessage('info', message);
            } else {
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        function showMessage(type, text) {
            messageDiv.textContent = text;
            messageDiv.className = 'mt-6 text-center text-sm'; // Reset
            switch (type) {
                case 'success':
                    messageDiv.classList.add('text-green-600', 'font-semibold');
                    break;
                case 'error':
                    messageDiv.classList.add('text-red-600', 'font-semibold');
                    break;
                case 'info':
                    messageDiv.classList.add('text-blue-600');
                    break;
            }
        }

        // Rumus Haversine untuk menghitung jarak
        function haversineDistance(lat1, lon1, lat2, lon2) {
            function toRad(x) {
                return x * Math.PI / 180;
            }

            const R = 6371000; // Radius Bumi dalam meter
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            return d; // Jarak dalam meter
        }

        // Panggil initCamera saat halaman dimuat
        document.addEventListener('DOMContentLoaded', initCamera);

    </script>
</body>
</html>

