<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Bawaslu Riau1</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Kustom untuk Pop-up Modal */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        body.modal-active {
            overflow-y: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div class="container mx-auto max-w-lg p-5">
        
        <!-- Konten Aplikasi Absensi -->
        <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 my-10">
            
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">
                Aplikasi Absensi
            </h1>
            <p class="text-center text-gray-600 mb-6">
                Bawaslu Provinsi Riau
            </p>

            <!-- Form Absensi -->
            <form id="absensiForm">
                
                <!-- Pilihan Kabupaten -->
                <div class="mb-4">
                    <label for="kabupaten" class="block text-sm font-medium text-gray-700 mb-1">Pilih Kabupaten/Kota</label>
                    <select id="kabupaten" name="kabupaten" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Pilih Kabupaten/Kota --</option>
                        <option value="Pekanbaru">Pekanbaru</option>
                        <option value="Dumai">Dumai</option>
                        <option value="Kuansing">Kuansing</option>
                        <option value="Rokan Hulu">Rokan Hulu</option>
                        <option value="Rokan Hilir">Rokan Hilir</option>
                        <option value="Indragiri Hulu">Indragiri Hulu</option>
                        <option value="Indragiri Hilir">Indragiri Hilir</option>
                        <option value="Kampar">Kampar</option>
                        <option value="Siak">Siak</option>
                        <option value="Bengkalis">Bengkalis</option>
                        <option value="Kep. Meranti">Kep. Meranti</option>
                        <option value="Pelalawan">Pelalawan</option>
                    </select>
                </div>

                <!-- Pilihan Pimpinan (Dinamis) -->
                <div class="mb-4">
                    <label for="pimpinan" class="block text-sm font-medium text-gray-700 mb-1">Nama Pimpinan</label>
                    <select id="pimpinan" name="pimpinan" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
                        disabled>
                        <option value="">-- Pilih Kabupaten terlebih dahulu --</option>
                    </select>
                </div>

                <!-- Pilihan Presensi -->
                <div class="mb-4">
                    <label for="jenisPresensi" class="block text-sm font-medium text-gray-700 mb-1">Jenis Presensi</label>
                    <select id="jenisPresensi" name="jenisPresensi" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Pilih Jenis Presensi --</option>
                        <option value="Presensi Masuk">Presensi Masuk</option>
                        <option value="Presensi Pulang">Presensi Pulang</option>
                    </select>
                </div>

                <!-- Upload Foto -->
                <div class="mb-6">
                    <label for="fotoSelfie" class="block text-sm font-medium text-gray-700 mb-1">Upload Foto Selfie</label>
                    <!-- 
                        Atribut 'capture="user"' akan memprioritaskan pembukaan kamera depan.
                        Atribut 'accept="image/*"' memastikan hanya gambar yang bisa diambil.
                        Ini adalah cara HTML standar untuk meminta input kamera.
                    -->
                    <input type="file" id="fotoSelfie" name="fotoSelfie" accept="image/*" capture="user" required
                        class="w-full text-sm text-gray-500
                               file:mr-4 file:py-2 file:px-4
                               file:rounded-md file:border-0
                               file:text-sm file:font-semibold
                               file:bg-blue-50 file:text-blue-700
                               hover:file:bg-blue-100">
                    <img id="previewFoto" class="mt-4 rounded-md hidden max-h-60 mx-auto" alt="Preview Foto"/>
                </div>

                <!-- Tombol Kirim -->
                <button type="submit" id="submitButton"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md focus:outline-none focus:shadow-outline transition duration-150 ease-in-out">
                    <span id="buttonText">Kirim Absensi</span>
                    <span id="loadingSpinner" class="hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Memproses...
                    </span>
                </button>

            </form>
        </div>
    </div>

    <!-- Pop-up Modal -->
    <div id="modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        
        <div class="modal-content bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto transform -translate-y-full">
            
            <!-- Konten Modal -->
            <div class="py-4 text-left px-6">
                <!-- Judul Modal -->
                <div class="flex justify-between items-center pb-3">
                    <p id="modalTitle" class="text-2xl font-bold">Notifikasi</p>
                    <div class="modal-close cursor-pointer z-50" onclick="hidePopup()">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Isi Modal -->
                <p id="modalMessage">Ini adalah pesan notifikasi.</p>
                
                <!-- Tombol Modal -->
                <div class="flex justify-end pt-2">
                    <button class="px-4 bg-blue-600 p-2 rounded-lg text-white hover:bg-blue-700" onclick="hidePopup()">Tutup</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- PENTING: KONFIGURASI ---
        // Ganti dengan URL Web App Google Apps Script Anda setelah di-deploy
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxQo_kl_9XWYkEXXAN-slH6vGajkhxAnApsXJ-uAKHBYJssOn-Kce_h3lofcsPt7tM6/exec"; 
        // ------------------------------

        // Data Pimpinan
        const dataPimpinan = {
            "Pekanbaru": ["Ferdy", "Misbah Ibrahim", "Reni Purba", "Raja Inal Dalimunthe", "Taufik Hidayat"],
            "Dumai": ["Agustri", "Yosi Renaldi", "Yeni Kartini"],
            "Kuansing": ["Ade Indra Sakti", "Nur Afni", "Mardius Adi Saputra"],
            "Rokan Hulu": ["Fajrul Islami Damsir", "Gummer Siregar", "Yurnalis", "Wikki Yuliandra", "Safrizal Hasbi"],
            "Rokan Hilir": ["Zubaidah", "Jaka Abdillah", "Nasrudin", "Dedi Sibuae", "Nurmaidani"],
            "Indragiri Hulu": ["Dedi Risanto", "Dwi Apriansyah Indra", "M.Lukman Said", "Said M Affandi", "Salestia Deni"],
            "Indragiri Hilir": ["Rustam", "Rahmaddian", "Abus Siraj", "Indra", "Musdalifa"],
            "Kampar": ["Syawir Abdullah", "Miki AB", "Mustaqim Akbar", "Fadriansyah", "Mhd. Amin S"],
            "Siak": ["Zulfadli Nugraha", "Ahmad Dardiri", "Harlen Manurung", "M.Andi Susilawan", "Ikhsan Parulian Harap"],
            "Bengkalis": ["Usman", "Budi Kurnialis", "Andi Setiawan", "Arsi Suprianto", "Mendra"],
            "Kep. Meranti": ["Syamsurizal", "Rio Andika", "M. Hafit"],
            "Pelalawan": ["Andrizal", "Bambang Sugi Hartono", "Syakir Hamdani", "Ari Nugroho Susanto", "Ruda Nur Kisawan"]
        };

        // Data Koordinat Kantor (Geo-fencing)
        const koordinatKantor = {
            "Pekanbaru": { lat: 0.5228952, lng: 101.4429202 },
            "Dumai": { lat: 1.6630254508232711, lng: 101.45249334765391 },
            "Kuansing": { lat: -0.534470, lng: 101.569874 },
            "Rokan Hulu": { lat: 0.876158, lng: 100.286686 },
            "Rokan Hilir": { lat: 2.158803, lng: 100.799874 },
            "Indragiri Hulu": { lat: 2.158803, lng: 100.799874 }, // Data sama dengan Rohil? Sesuai permintaan
            "Indragiri Hilir": { lat: -0.3201440, lng: 103.1542940 },
            "Kampar": { lat: 0.324784, lng: 101.026305 },
            "Siak": { lat: 0.814464, lng: 102.018998 },
            "Bengkalis": { lat: 1.473969, lng: 102.123841 },
            "Kep. Meranti": { lat: 1.008499, lng: 102.712468 },
            "Pelalawan": { lat: 2.158803, lng: 100.799874 } // Data sama dengan Rohil? Sesuai permintaan
        };

        const batasJarakMeter = 100;

        // Elemen DOM
        const form = document.getElementById('absensiForm');
        const selectKabupaten = document.getElementById('kabupaten');
        const selectPimpinan = document.getElementById('pimpinan');
        const inputFoto = document.getElementById('fotoSelfie');
        const previewFoto = document.getElementById('previewFoto');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');

        // Event Listener untuk dropdown kabupaten
        selectKabupaten.addEventListener('change', function() {
            const selectedKabupaten = this.value;
            selectPimpinan.innerHTML = ''; // Kosongkan pilihan lama
            
            if (selectedKabupaten && dataPimpinan[selectedKabupaten]) {
                selectPimpinan.disabled = false;
                selectPimpinan.style.backgroundColor = 'white';
                selectPimpinan.add(new Option('-- Pilih Nama Pimpinan --', ''));
                
                dataPimpinan[selectedKabupaten].forEach(nama => {
                    selectPimpinan.add(new Option(nama, nama));
                });
            } else {
                selectPimpinan.disabled = true;
                selectPimpinan.style.backgroundColor = 'rgb(249 250 251)';
                selectPimpinan.add(new Option('-- Pilih Kabupaten terlebih dahulu --', ''));
            }
        });

        // Event listener untuk preview foto
        inputFoto.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewFoto.src = e.target.result;
                    previewFoto.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            } else {
                previewFoto.classList.add('hidden');
            }
        });

        // Event listener untuk submit form
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            setLoading(true);
            handleFormSubmit();
        });

        // Fungsi utama handle submit
        async function handleFormSubmit() {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const file = inputFoto.files[0];

            // 1. Cek Anti-Kecurangan (LocalStorage)
            const today = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD
            const storageKey = `absensi_${data.jenisPresensi}_${data.pimpinan}_${today}`;
            
            if (localStorage.getItem(storageKey)) {
                showPopup('Peringatan', 'Anda terdeteksi melakukan absensi berulang (<strong>' + data.jenisPresensi + '</strong> atas nama <strong>' + data.pimpinan + '</strong>) pada perangkat yang sama hari ini.');
                setLoading(false);
                return;
            }

            // 2. Cek Geolocation
            try {
                const userLocation = await getCurrentLocation();
                const targetLocation = koordinatKantor[data.kabupaten];

                if (!targetLocation) {
                    showPopup('Error', 'Data koordinat untuk ' + data.kabupaten + ' tidak ditemukan.');
                    setLoading(false);
                    return;
                }

                const distance = getDistance(userLocation, targetLocation);

                // 3. Cek Geofencing
                if (distance > batasJarakMeter) {
                    showPopup('Lokasi Ditolak', `Anda saat ini tidak dapat melakukan absensi karena berada <strong>${distance.toFixed(0)} meter</strong> dari titik lokasi kantor. (Batas: ${batasJarakMeter} meter)`);
                    setLoading(false);
                    return;
                }

                // 4. Jika Lolos: Konversi gambar ke Base64
                const fotoBase64 = await toBase64(file);
                
                const payload = {
                    kabupaten: data.kabupaten,
                    pimpinan: data.pimpinan,
                    jenisPresensi: data.jenisPresensi,
                    timestamp: new Date().toISOString(),
                    fileName: `${data.pimpinan}_${data.jenisPresensi}_${today}.jpg`,
                    fotoBase64: fotoBase64
                };

                // 5. Kirim data ke Google Apps Script
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // ... existing code ... -->
                    form.reset(); // Reset form setelah sukses
                    previewFoto.classList.add('hidden');
                } else {
                    // ... existing code ... -->
                    showPopup('Terjadi Kesalahan', result.message || 'Gagal mengirim data.');
                }

            } catch (error) {
                // --- KODE LAMA (DIHAPUS) ---
                // // Tangani error (misal: user menolak izin lokasi)
                // let errorMessage = 'Terjadi kesalahan: ' + error.message;
                // if (error.code === 1) { // User denied geolocation
                //     errorMessage = 'Anda harus mengizinkan akses lokasi untuk melakukan absensi.';
                // }
                // showPopup('Error GPS', errorMessage);

                // --- KODE BARU (DITAMBAHKAN) ---
                // Tangani error dengan lebih spesifik
                if (error.code && (error.code === 1 || error.code === 2 || error.code === 3)) {
                    // Ini adalah error spesifik dari Geolocation API
                    let gpsMessage = 'Terjadi kesalahan GPS: ';
                    if (error.code === 1) { // User denied geolocation
                        gpsMessage = 'Anda harus mengizinkan akses lokasi untuk melakukan absensi. Silakan cek izin lokasi di browser Anda (ikon ðŸ”’ di URL).';
                    } else if (error.code === 2) { // Position unavailable
                        gpsMessage = 'Lokasi Anda tidak dapat ditemukan. Coba lagi di tempat lebih terbuka.';
                    } else if (error.code === 3) { // Timeout
                        gpsMessage = 'Gagal mendapatkan lokasi (timeout 10 detik). Sinyal GPS lemah atau butuh waktu lebih lama.';
                    }
                    showPopup('Error GPS', gpsMessage);
                } else {
                    // Ini kemungkinan besar adalah error JARINGAN (Network) atau error lainnya
                    let networkMessage = 'Terjadi kesalahan: ' + error.message;
                    if (error.message.toLowerCase().includes('failed to fetch')) {
                        networkMessage = 'Koneksi ke server gagal (Failed to fetch). Pastikan URL Apps Script benar dan Anda memiliki koneksi internet yang stabil.';
                    }
                    // Tampilkan error di console untuk debugging
                    console.error("Error non-GPS terdeteksi:", error);
                    showPopup('Error Jaringan / Lainnya', networkMessage);
                }
                // --- AKHIR KODE BARU ---
            } finally {
                setLoading(false);
            }
        }

        // --- Fungsi Helper ---

        // Fungsi Loading state
        function setLoading(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                buttonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                submitButton.disabled = false;
                buttonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        // Fungsi Pop-up
        function showPopup(title, message) {
            modalTitle.innerHTML = title;
            modalMessage.innerHTML = message;
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('-translate-y-full');
            document.body.classList.add('modal-active');
        }

        function hidePopup() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('-translate-y-full');
            document.body.classList.remove('modal-active');
        }

        // Fungsi mendapatkan lokasi user
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation tidak didukung oleh browser ini.'));
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    (error) => {
                        reject(error); // error.code 1: Permission denied
                    },
                    {
                        enableHighAccuracy: true, // Minta GPS akurasi tinggi
                        timeout: 10000, // Timeout 10 detik
                        maximumAge: 0 // Jangan gunakan cache lokasi
                    }
                );
            });
        }

        // Fungsi Haversine (Hitung Jarak)
        function getDistance(coord1, coord2) {
            const R = 6371e3; // Radius bumi dalam meter
            const lat1 = coord1.lat * Math.PI/180;
            const lat2 = coord2.lat * Math.PI/180;
            const deltaLat = (coord2.lat - coord1.lat) * Math.PI/180;
            const deltaLng = (coord2.lng - coord1.lng) * Math.PI/180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                      Math.cos(lat1) * Math.cos(lat2) *
                      Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Jarak dalam meter
        }

        // Fungsi Konversi File ke Base64
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

    </script>
</body>
</html>
