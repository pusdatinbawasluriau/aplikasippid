<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Bawaslu Riau</title>
    <!-- Memuat Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Menggunakan font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icon (Tabler Icons) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex items-center justify-center min-h-screen py-12 px-4">
        <div class="w-full max-w-2xl mx-auto">
            <!-- Peringatan Konfigurasi GAS -->
            <div id="gasWarning" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6" role="alert">
                <p class="font-bold">Konfigurasi Diperlukan!</p>
                <p>Aplikasi belum terhubung. Harap masukkan URL Google Apps Script (GAS) di file HTML ini pada variabel `GAS_APP_URL`.</p>
            </div>

            <!-- Form Absensi -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-center text-gray-800 mb-4">
                    Selamat Datang di Aplikasi Absensi
                </h2>
                <p class="text-center text-gray-600 mb-6">Bawaslu Provinsi Riau21</p>

                <form id="absensiForm" class="space-y-6">
                    <!-- Pilih Kabupaten -->
                    <div>
                        <label for="kabupatenSelect" class="block text-sm font-medium text-gray-700">Pilih Kabupaten</label>
                        <select id="kabupatenSelect" name="kabupaten" required
                                class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Pilih Kabupaten --</option>
                            <!-- Opsi diisi oleh JS -->
                        </select>
                    </div>

                    <!-- Pilih Nama Pimpinan -->
                    <div>
                        <label for="namaSelect" class="block text-sm font-medium text-gray-700">Pilih Nama Pimpinan</label>
                        <select id="namaSelect" name="nama" required disabled
                                class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-50 disabled:opacity-75">
                            <option value="">-- Pilih Kabupaten Terlebih Dahulu --</option>
                        </select>
                    </div>

                    <!-- Pilih Presensi -->
                    <div>
                        <label for="presensiSelect" class="block text-sm font-medium text-gray-700">Pilih Presensi</label>
                        <select id="presensiSelect" name="presensi" required
                                class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Pilih Jenis Presensi --</option>
                            <option value="Masuk">Presensi Masuk</option>
                            <option value="Pulang">Presensi Pulang</option>
                        </select>
                    </div>

                    <!-- Upload Foto Selfi -->
                    <div>
                        <label for="fotoInput" class="block text-sm font-medium text-gray-700">Upload Foto Selfi (Hanya via Kamera)</label>
                        <input type="file" id="fotoInput" name="foto" accept="image/*" capture="user" required
                               class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4
                                      file:rounded-md file:border-0 file:text-sm file:font-semibold
                                      file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100
                                      border border-gray-300 rounded-md p-2"/>
                        <img id="fotoPreview" src="" alt="Preview Foto" class="hidden w-full max-w-xs mt-4 rounded-md shadow-md mx-auto"/>
                    </div>

                    <!-- Tombol Kirim -->
                    <div>
                        <button type="submit" id="kirimAbsensiBtn"
                                class="w-full px-4 py-3 font-medium text-white bg-blue-600 rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 flex items-center justify-center space-x-2">
                            <i class="ti ti-send"></i>
                            <span>Kirim Absensi</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ===== Custom Notification Modal ===== -->
    <div id="notificationModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4 transform transition-all scale-95 opacity-0">
            <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                <h3 id="modalTitle" class="text-lg font-medium leading-6 text-gray-900">Notifikasi</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="ti ti-x text-2xl"></i>
                </button>
            </div>
            <div class="mt-4">
                <p id="modalMessage" class="text-sm text-gray-600">Isi pesan notifikasi.</p>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="okModalBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none">
                    OK
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // ========================================================================
        // KONFIGURASI PENTING
        // GANTI URL DI BAWAH INI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA
        // ========================================================================
        const GAS_APP_URL = 'https://script.google.com/macros/s/AKfycbzkk8WWdXxJvyQaulHczDyPJJTKYTV3OC-8roS1P0hs89F51zBWLJNGNQGT_rDAdw3HyA/exec'; // <-- ISI URL ANDA DI SINI
        // Contoh: const GAS_APP_URL = 'https://script.google.com/macros/s/ABCDEFG.../exec';
        
        // ========================================================================
        // DATA UNTUK FORM ABSENSI
        // ========================================================================
        const pimpinanData = {
            "Pekanbaru": ["Ferdy", "Misbah Ibrahim", "Reni Purba", "Raja Inal Dalimunthe", "Taufik Hidayat"],
            "Dumai": ["Agustri", "Yosi Renaldi", "Yeni Kartini"],
            "Kuansing": ["Ade Indra Sakti", "Nur Afni", "Mardius Adi Saputra"],
            "Rokan Hulu": ["Fajrul Islami Damsir", "Gummer Siregar", "Yurnalis", "Wikki Yuliandra", "Safrizal Hasbi"],
            "Rokan Hilir": ["Zubaidah", "Jaka Abdillah", "Nasrudin", "Dedi Sibuae", "Nurmaidani"],
            "Indragiri Hulu": ["Dedi Risanto", "Dwi Apriansyah Indra", "M.Lukman Said", "Said M Affandi", "Salestia Deni"],
            "Indragiri Hilir": ["Rustam", "Rahmaddian", "Abus Siraj", "Indra", "Musdalifa"],
            "Kampar": ["Syawir Abdullah", "Miki AB", "Mustaqim Akbar", "Fadriansyah", "Mhd. Amin S"],
            "Siak": ["Zulfadli Nugraha", "Ahmad Dardiri", "Harlen Manurung", "M.Andi Susilawan", "Ikhsan Parulian Harap"],
            "Bengkalis": ["Usman", "Budi Kurnialis", "Andi Setiawan", "Arsi Suprianto", "Mendra"],
            "Kep.Meranti": ["Syamsurizal", "Rio Andika", "M. Hafit"],
            "Pelalawan": ["Andrizal", "Bambang Sugi Hartono", "Syakir Hamdani", "Ari Nugroho Susanto", "Ruda Nur Kisawan"]
        };

        const koordinatData = {
            "Pekanbaru": { lat: 0.5228952, lon: 101.4429202 },
            "Dumai": { lat: 1.6630254508232711, lon: 101.45249334765391 },
            "Kuansing": { lat: -0.534470, lon: 101.569874 },
            "Rokan Hulu": { lat: 0.876158, lon: 100.286686 },
            "Rokan Hilir": { lat: 2.158803, lon: 100.799874 },
            "Indragiri Hulu": { lat: 2.158803, lon: 100.799874 },
            "Indragiri Hilir": { lat: -0.3201440, lon: 103.1542940 },
            "Kampar": { lat: 0.324784, lon: 101.026305 },
            "Siak": { lat: 0.814464, lon: 102.018998 },
            "Bengkalis": { lat: 1.473969, lon: 102.123841 },
            "Kep.Meranti": { lat: 1.008499, lon: 102.712468 },
            "Pelalawan": { lat: 2.158803, lon: 100.799874 }
        };

        // ========================================================================
        // ELEMEN DOM
        // ========================================================================
        
        const gasWarning = document.getElementById('gasWarning');
        const absensiForm = document.getElementById('absensiForm');
        const kabupatenSelect = document.getElementById('kabupatenSelect');
        const namaSelect = document.getElementById('namaSelect');
        const presensiSelect = document.getElementById('presensiSelect');
        const fotoInput = document.getElementById('fotoInput');
        const fotoPreview = document.getElementById('fotoPreview');
        const kirimAbsensiBtn = document.getElementById('kirimAbsensiBtn');

        // Elemen Modal
        const notificationModal = document.getElementById('notificationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const okModalBtn = document.getElementById('okModalBtn');

        // ========================================================================
        // FUNGSI MODAL NOTIFIKASI
        // ========================================================================
        
        function showNotification(title, message, isError = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            if (isError) {
                modalTitle.classList.remove('text-gray-900');
                modalTitle.classList.add('text-red-600');
            } else {
                modalTitle.classList.remove('text-red-600');
                modalTitle.classList.add('text-gray-900');
            }

            notificationModal.style.display = 'flex';
            setTimeout(() => {
                notificationModal.querySelector('div.transform').classList.add('scale-100', 'opacity-100');
                notificationModal.querySelector('div.transform').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeNotification() {
            notificationModal.querySelector('div.transform').classList.remove('scale-100', 'opacity-100');
            notificationModal.querySelector('div.transform').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                notificationModal.style.display = 'none';
            }, 150);
        }

        closeModalBtn.addEventListener('click', closeNotification);
        okModalBtn.addEventListener('click', closeNotification);

        // ========================================================================
        // FUNGSI FORM ABSENSI
        // ========================================================================

        function setupAbsensiForm() {
            populateKabupaten();
            kabupatenSelect.addEventListener('change', updateNamaDropdown);
            fotoInput.addEventListener('change', previewFoto);
            absensiForm.addEventListener('submit', handleAbsensiSubmit);
        }

        function populateKabupaten() {
            const kabupatens = Object.keys(pimpinanData);
            kabupatens.sort();
            kabupatens.forEach(kab => {
                const option = document.createElement('option');
                option.value = kab;
                option.textContent = kab;
                kabupatenSelect.appendChild(option);
            });
        }

        function updateNamaDropdown() {
            const selectedKabupaten = kabupatenSelect.value;
            namaSelect.innerHTML = ''; // Kosongkan list
            
            if (selectedKabupaten && pimpinanData[selectedKabupaten]) {
                namaSelect.disabled = false;
                namaSelect.classList.remove('bg-gray-50', 'disabled:opacity-75');

                const optionDefault = document.createElement('option');
                optionDefault.value = '';
                optionDefault.textContent = '-- Pilih Nama --';
                namaSelect.appendChild(optionDefault);

                pimpinanData[selectedKabupaten].forEach(nama => {
                    const option = document.createElement('option');
                    option.value = nama;
                    option.textContent = nama;
                    namaSelect.appendChild(option);
                });
            } else {
                namaSelect.disabled = true;
                namaSelect.classList.add('bg-gray-50', 'disabled:opacity-75');
                
                const optionDefault = document.createElement('option');
                optionDefault.value = '';
                optionDefault.textContent = '-- Pilih Kabupaten Terlebih Dahulu --';
                namaSelect.appendChild(optionDefault);
            }
        }

        function previewFoto() {
            const file = fotoInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    fotoPreview.src = e.target.result;
                    fotoPreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                fotoPreview.src = '';
                fotoPreview.classList.add('hidden');
            }
        }

        async function handleAbsensiSubmit(e) {
            e.preventDefault();
            
            const kabupaten = kabupatenSelect.value;
            const nama = namaSelect.value;
            const presensi = presensiSelect.value;
            const foto = fotoInput.files[0];

            if (!kabupaten || !nama || !presensi || !foto) {
                showNotification("Error Validasi", "Semua kolom (Kabupaten, Nama, Presensi, dan Foto) wajib diisi.", true);
                return;
            }

            const today = new Date().toLocaleDateString('id-ID');
            const submissionToken = `absensi_${today}_${nama}_${presensi}`;
            if (sessionStorage.getItem(submissionToken)) {
                showNotification("Deteksi Kecurangan", "Anda terdeteksi melakukan absensi berulang pada perangkat yang sama untuk jenis presensi ini hari ini.", true);
                return;
            }

            setSubmitButtonLoading(true, 'Mengecek Lokasi GPS...');

            try {
                const userLocation = await getGeolocation();
                const targetLocation = koordinatData[kabupaten];

                if (!targetLocation) {
                    showNotification("Error", "Data koordinat untuk kabupaten ini tidak ditemukan.", true);
                    setSubmitButtonLoading(false);
                    return;
                }

                const distance = calculateDistance(
                    userLocation.latitude, userLocation.longitude,
                    targetLocation.lat, targetLocation.lon
                );

                if (distance > 100) {
                    showNotification("Lokasi Ditolak", `Anda saat ini tidak dapat melakukan absensi karena berada ${Math.round(distance)} meter dari titik lokasi kantor.`, true);
                    setSubmitButtonLoading(false);
                    return;
                }

                setSubmitButtonLoading(true, 'Mengirim data absensi...');

                const formData = new FormData();
                formData.append('action', 'submitAbsensi');
// ... (Bagian ini sama seperti sebelumnya, mengirim data)
                formData.append('kabupaten', kabupaten);
                formData.append('nama', nama);
                formData.append('presensi', presensi);
                formData.append('foto', foto);
                formData.append('timestamp', new Date().toISOString());
                formData.append('latitude', userLocation.latitude);
                formData.append('longitude', userLocation.longitude);

                if (!GAS_APP_URL) {
                    showNotification("Error Konfigurasi", "URL Google Apps Script (GAS) belum diatur di kode. Pengiriman dibatalkan.", true);
                    setSubmitButtonLoading(false);
                    return;
                }

                const response = await fetch(GAS_APP_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const responseText = await response.text();
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (jsonError) {
                    console.error("Gagal parse JSON dari GAS:", responseText);
                    throw new Error("Respon server tidak valid. Pastikan GAS mengembalikan JSON.");
                }

                if (result.status === 'success') {
                    sessionStorage.setItem(submissionToken, 'true');
                    const tglSukses = new Date().toLocaleDateString('id-ID', { dateStyle: 'long' });
                    showNotification("Absensi Berhasil", `Absensi '${presensi}' atas nama '${nama}' pada ${tglSukses} telah dikirim.`);
                    absensiForm.reset();
                    fotoPreview.classList.add('hidden');
                    fotoPreview.src = '';
                    updateNamaDropdown();
                } else if (result.status === 'duplicate') {
                    sessionStorage.setItem(submissionToken, 'true');
                    showNotification("Absensi Ditolak", "Anda sudah melakukan absensi untuk jenis ini hari ini.", true);
                } else {
                    throw new Error(result.message || "Terjadi kesalahan saat mengirim data.");
                }

            } catch (error) {
                console.error('Gagal submit absensi:', error);
                showNotification("Error", error.message || "Gagal mengirim data. Cek konsol untuk detail.", true);
            } finally {
                setSubmitButtonLoading(false);
            }
        }

        function setSubmitButtonLoading(isLoading, message = "Kirim Absensi") {
            const btn = kirimAbsensiBtn;
            const icon = btn.querySelector('i');
            const text = btn.querySelector('span');

            if (isLoading) {
                btn.disabled = true;
                btn.classList.add('bg-opacity-70', 'cursor-not-allowed');
                icon.className = 'ti ti-loader animate-spin';
                text.textContent = message;
            } else {
                btn.disabled = false;
                btn.classList.remove('bg-opacity-70', 'cursor-not-allowed');
                icon.className = 'ti ti-send';
                text.textContent = "Kirim Absensi";
            }
        }

        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation tidak didukung oleh browser ini."));
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve(position.coords);
                    },
                    (error) => {
                        // === PERUBAHAN DI SINI ===
                        let errorMsg = "Terjadi kesalahan saat mengambil lokasi.";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = "Anda menolak izin lokasi. Absensi tidak dapat dilanjutkan. Harap muat ulang halaman dan klik 'Izinkan' (Allow) saat browser meminta izin lokasi.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = "Informasi lokasi tidak tersedia. Pastikan layanan GPS di perangkat Anda aktif dan coba lagi.";
                                break;
                            case error.TIMEOUT:
                                errorMsg = "Waktu permintaan lokasi habis. Sinyal GPS mungkin lemah, silakan coba lagi di area yang lebih terbuka.";
                                break;
                        }
                        reject(new Error(errorMsg));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // meter
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaPhi = (lat2 - lat1) * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // jarak dalam meter
        }

        // ========================================================================
        // INISIALISASI
        // ========================================================================
        document.addEventListener('DOMContentLoaded', () => {
            if (!GAS_APP_URL) {
                console.warn('URL GAS belum diatur!');
                gasWarning.style.display = 'block';
            } else {
                gasWarning.style.display = 'none';
            }
            setupAbsensiForm();
        });

    </script>
</body>
</html>
