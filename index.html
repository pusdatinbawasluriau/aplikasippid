<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Usaha perbaikan untuk Permissions Policy -->
    <meta http-equiv="Permissions-Policy" content="geolocation=*">
    <title>Absensi Bawaslu Riau</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style untuk loading spinner sederhana */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* blue-600 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-lg p-8 rounded-xl shadow-lg">
        
        <header class="text-center mb-6">
            <img src="https://placehold.co/100x100/e0e0e0/333?text=Logo" alt="Logo Bawaslu" class="mx-auto mb-4 w-20 h-20 rounded-full object-cover" onerror="this.src='https://placehold.co/100x100/e0e0e0/333?text=Logo'"/>
            <h1 class="text-2xl font-bold text-gray-800">
                Selamat Datang di Aplikasi Absensi
            </h1>
            <p class="text-lg text-gray-600">Bawaslu Provinsi Riau</p>
        </header>

        <form id="absensiForm">
            <!-- Pilihan Kabupaten/Kota -->
            <div class="mb-4">
                <label for="kabupatenSelect" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kabupaten/Kota:</label>
                <select id="kabupatenSelect" name="kabupaten" class="w-full p-3 border border-gray-300 rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                    <option value="pekanbaru">Pekanbaru</option>
                    <option value="dumai">Dumai</option>
                    <option value="kuansing">Kuansing</option>
                </select>
            </div>

            <!-- Pilihan Nama Pimpinan -->
            <div class="mb-4">
                <label for="namaSelect" class="block text-sm font-medium text-gray-700 mb-2">Pilih Nama Pimpinan:</label>
                <select id="namaSelect" name="nama" class="w-full p-3 border border-gray-300 rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                    <!-- Opsi nama akan diisi oleh JavaScript -->
                </select>
            </div>

            <!-- Pilihan Jenis Presensi -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Presensi:</label>
                <div class="flex flex-col sm:flex-row sm:gap-6">
                    <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                        <input type="radio" name="presensiType" value="Presensi Masuk" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" required>
                        <span class="ml-3 text-gray-700">Presensi Masuk</span>
                    </label>
                    <label class="flex items-center mt-2 sm:mt-0 p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                        <input type="radio" name="presensiType" value="Presensi Pulang" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" required>
                        <span class="ml-3 text-gray-700">Presensi Pulang</span>
                    </label>
                </div>
            </div>

            <!-- Tombol Kirim -->
            <button id="submitButton" type="submit" class="w-full bg-blue-600 text-white p-3 rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200 disabled:bg-gray-400 flex items-center justify-center gap-2">
                Kirim Absensi
            </button>

            <!-- Status Message -->
            <div id="statusMessage" role="alert" class="mt-4 text-center p-3 rounded-md text-sm" aria-live="assertive">
                <!-- Pesan sukses atau error akan muncul di sini -->
            </div>

            <!-- Loading Indicator (hidden by default) -->
            <div id="loadingIndicator" class="hidden items-center justify-center mt-4 gap-2 text-gray-600">
                <div class="spinner"></div>
                <span>Mencari lokasi Anda...</span>
            </div>

        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- DATA SIMULASI ---
            // Data pimpinan berdasarkan kabupaten
            const pimpinanData = {
                pekanbaru: ["Verdi", "Reni Purba", "Misbah Ibrahim", "Raja Inal", "Taufiq"],
                dumai: ["Yeni", "Adi", "Badu"],
                kuansing: ["Susi", "Adi", "Iqbal"]
            };

            // Data simulasi koordinat kantor (admin-defined)
            // Titik Bawaslu Riau dari link: 0.4918, 101.4449
            const kantorCoordinates = {
                // GANTI KOORDINAT DI BAWAH INI DENGAN TITIK GPS YANG SEHARUSNYA
                pekanbaru: { lat: 0.499579, lon: 101.444959 }, // <-- Ganti nilai lat/lon ini
                dumai: { lat: 1.6740, lon: 101.4450 }, // <-- Ganti nilai lat/lon ini
                kuansing: { lat: -0.5180, lon: 101.5360 } // <-- Ganti nilai lat/lon ini
            };
            const MAX_DISTANCE_METERS = 500; // Jarak toleransi diubah ke 500 meter

            // --- REFERENSI ELEMEN ---
            const kabupatenSelect = document.getElementById('kabupatenSelect');
            const namaSelect = document.getElementById('namaSelect');
            const absensiForm = document.getElementById('absensiForm');
            const submitButton = document.getElementById('submitButton');
            const statusMessage = document.getElementById('statusMessage');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // --- FUNGSI ---

            /**
             * Memperbarui daftar nama pimpinan berdasarkan kabupaten yang dipilih.
             */
            function updateNamaPimpinan() {
                const selectedKabupaten = kabupatenSelect.value;
                const pimpinanList = pimpinanData[selectedKabupaten] || [];
                
                // Kosongkan select nama
                namaSelect.innerHTML = ''; 

                // Isi dengan nama yang baru
                if (pimpinanList.length > 0) {
                    pimpinanList.forEach(nama => {
                        const option = document.createElement('option');
                        option.value = nama.toLowerCase().replace(' ', '-');
                        option.textContent = nama;
                        namaSelect.appendChild(option);
                    });
                    namaSelect.disabled = false;
                } else {
                    const option = document.createElement('option');
                    option.textContent = 'Tidak ada data';
                    namaSelect.appendChild(option);
                    namaSelect.disabled = true;
                }
            }

            /**
             * Menampilkan pesan status kepada pengguna.
             * @param {string} message - Pesan yang akan ditampilkan.
             * @param {('success'|'error'|'info')} type - Jenis pesan.
             */
            function showMessage(message, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.className = 'mt-4 text-center p-3 rounded-md text-sm'; // Reset
                
                if (type === 'success') {
                    statusMessage.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    statusMessage.classList.add('bg-red-100', 'text-red-800');
                } else {
                    statusMessage.classList.add('bg-blue-100', 'text-blue-800');
                }
            }

            /**
             * Mengatur status loading
             * @param {boolean} isLoading - true jika sedang loading.
             */
            function setLoading(isLoading) {
                if (isLoading) {
                    submitButton.disabled = true;
                    submitButton.classList.add('disabled:bg-gray-400');
                    loadingIndicator.classList.remove('hidden');
                    loadingIndicator.classList.add('flex');
                    statusMessage.innerHTML = ''; // Hapus pesan lama
                } else {
                    submitButton.disabled = false;
                    loadingIndicator.classList.add('hidden');
                    loadingIndicator.classList.remove('flex');
                }
            }

            /**
             * Menghitung jarak Haversine antara dua titik GPS dalam meter.
             */
            function haversineDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Radius Bumi dalam meter
                const phi1 = lat1 * Math.PI / 180;
                const phi2 = lat2 * Math.PI / 180;
                const deltaPhi = (lat2 - lat1) * Math.PI / 180;
                const deltaLambda = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                          Math.cos(phi1) * Math.cos(phi2) *
                          Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                
                return R * c; // Jarak dalam meter
            }

            /**
             * Handler untuk proses submit form absensi.
             */
            async function handleAbsensiSubmit(event) {
                event.preventDefault(); // Mencegah form submit
                
                const formData = new FormData(absensiForm);
                const jenisPresensi = formData.get('presensiType');
                const selectedKabupaten = formData.get('kabupaten');

                if (!jenisPresensi) {
                    showMessage('Silakan pilih jenis presensi (Masuk atau Pulang).', 'error');
                    return;
                }
                
                setLoading(true);

                try {
                    // 1. Dapatkan lokasi GPS pengguna
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true, 
                            timeout: 10000, 
                            maximumAge: 0
                        });
                    });

                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;

                    // 2. Dapatkan koordinat kantor tujuan
                    const target = kantorCoordinates[selectedKabupaten];
                    if (!target) {
                        throw new Error("Koordinat kantor untuk kabupaten ini tidak ditemukan.");
                    }

                    // 3. Hitung jarak
                    const distance = haversineDistance(userLat, userLon, target.lat, target.lon);

                    // 4. Cek jarak
                    if (distance > MAX_DISTANCE_METERS) {
                        // Jarak terlalu jauh
                        showMessage(`Anda saat ini tidak dapat melakukan absensi karena berada jauh dari lokasi kantor. (Jarak: ${distance.toFixed(0)} meter)`, 'error');
                    } else {
                        // Jarak sesuai, sukses absensi
                        const tanggal = new Date().toLocaleDateString('id-ID', {
                            day: '2-digit', month: 'long', year: 'numeric'
                        });
                        
                        // Simulasi pengiriman data ke admin
                        console.log("MENGIRIM DATA KE ADMIN (SIMULASI):", {
                            kabupaten: selectedKabupaten,
                            nama: formData.get('nama'),
                            jenisPresensi: jenisPresensi,
                            tanggal: new Date().toISOString(),
                            lokasi: `${userLat}, ${userLon}`,
                            jarak: distance.toFixed(2) + ' meter'
                        });

                        showMessage(`Absensi '${jenisPresensi}' pada tanggal ${tanggal} telah dikirim.`, 'success');
                        
                        // Reset form
                        absensiForm.reset();
                        updateNamaPimpinan(); // Set nama kembali ke default
                    }

                } catch (error) {
                    // Tangani error GPS
                    let errorMsg = "Terjadi kesalahan.";

                    // Cek spesifik untuk error Permissions Policy
                    if (error.message && error.message.toLowerCase().includes("permissions policy")) {
                        errorMsg = "Error: Izin Geolocation diblokir oleh 'permissions policy'. Pratinjau ini mungkin tidak mendukung GPS. Coba buka file ini di tab browser terpisah.";
                    } else if (error.code === 1) { // PERMISSION_DENIED
                        errorMsg = "Izin lokasi ditolak. Anda harus mengizinkan akses lokasi di browser Anda.";
                    } else if (error.code === 2) { // POSITION_UNAVAILABLE
                        errorMsg = "Gagal mendapatkan lokasi. Pastikan GPS Anda aktif dan sinyal kuat.";
                    } else if (error.code === 3) { // TIMEOUT
                        errorMsg = "Waktu tunggu habis saat mencari lokasi. Coba lagi.";
                    } else {
                        // Fallback untuk error lain
                        errorMsg = `Gagal mendapatkan lokasi. Silakan coba lagi.`;
_                    }
                    
                    showMessage(errorMsg, 'error');
                    console.error("Geolocation Error:", error.message, error); // Log seluruh error object
                } finally {
                    setLoading(false); // Selalu hentikan loading
                }
            }

            // --- EVENT LISTENERS ---
            kabupatenSelect.addEventListener('change', updateNamaPimpinan);
            absensiForm.addEventListener('submit', handleAbsensiSubmit);

            // --- INISIALISASI ---
            updateNamaPimpinan(); // Panggil sekali saat load untuk mengisi data awal
        });
    </script>
</body>
</html>


