<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Bawaslu Riau</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Menggunakan font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* Style untuk Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            transition: opacity 0.3s ease-in-out;
        }
        /* Style untuk Modal Notifikasi */
        #notif-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        #notif-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- =========== HALAMAN ABSENSI =========== -->
    <div class="w-full max-w-md p-8 space-y-6 bg-white shadow-xl rounded-2xl">
        <h2 class="text-2xl font-bold text-center text-gray-800">
            Selamat Datang di Aplikasi Absensi
            <span class="block text-xl text-blue-600">Bawaslu Provinsi Riau</span>
        </h2>

        <form id="absen-form" class="space-y-5">
            <div>
                <label for="kabupaten" class="block text-sm font-medium text-gray-700">Pilih Kabupaten</label>
                <select id="kabupaten" name="kabupaten" required
                        class="w-full px-4 py-3 mt-1 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    <option value="">-- Pilih Kabupaten --</option>
                    <option value="Pekanbaru">Pekanbaru</option>
                    <option value="Dumai">Dumai</option>
                    <option value="Kuansing">Kuansing</option>
                </select>
            </div>

            <div>
                <label for="nama" class="block text-sm font-medium text-gray-700">Pilih Nama Pimpinan</label>
                <select id="nama" name="nama" required
                        class="w-full px-4 py-3 mt-1 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" disabled>
                    <option value="">-- Pilih Kabupaten Dulu --</option>
                </select>
            </div>

            <div>
                <label for="jenis-presensi" class="block text-sm font-medium text-gray-700">Jenis Presensi</label>
                <select id="jenis-presensi" name="jenis-presensi" required
                        class="w-full px-4 py-3 mt-1 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    <option value="Presensi Masuk">Presensi Masuk</option>
                    <option value="Presensi Pulang">Presensi Pulang</option>
                </select>
            </div>

            <button type="submit" id="btn-kirim"
                    class="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out">
                Kirim Absensi
            </button>
        </form>
    </div>

    <!-- =========== LOADING OVERLAY =========== -->
    <div id="loading-overlay" class="hidden">
        <div class="text-white text-center">
            <!-- Spinner -->
            <svg class="animate-spin h-10 w-10 text-white mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="text-lg font-medium">Mengecek lokasi GPS...</p>
        </div>
    </div>

    <!-- =========== MODAL NOTIFIKASI =========== -->
    <div id="notif-modal" class="hidden">
        <div class="w-full max-w-sm p-6 bg-white shadow-xl rounded-2xl text-center">
            <h3 id="notif-title" class="text-xl font-bold text-gray-800 mb-3">Notifikasi</h3>
            <p id="notif-message" class="text-gray-600 mb-5">Ini adalah pesan notifikasi.</p>
            <button id="btn-close-modal"
                    class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                Tutup
            </button>
        </div>
    </div>


    <script type="module">
        // =======================================================================
        //                       PENGATURAN PENTING
        // =======================================================================
        // 
        // TEMPELKAN URL WEB APP GOOGLE APPS SCRIPT ANDA DI SINI
        // Ganti string di bawah dengan URL yang Anda dapatkan setelah mendeploy
        // Google Apps Script Anda.
        //
        // INI HARUS URL YANG SAMA DENGAN YANG ADA DI 'index.html'
        //
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw9qQ_KjR6RFcAgTNG6O_PY-eo6EH7-PSPkhXT5bAM3oWNzrHWoj6ZjAwPin0asj4o/exec";
        //
        // =======================================================================
        
        // --- PENGATURAN LOKASI ---
        // Koordinat Target (Bawaslu Riau dari Google Maps link)
        const TARGET_LAT = 0.49162;
        const TARGET_LON = 101.43285;
        const MAX_DISTANCE_METERS = 100; // Jarak toleransi 100 meter

        // --- Data Pimpinan ---
        const pimpinanData = {
            "Pekanbaru": ["Verdi", "Reni Purba", "Misbah Ibrahim", "Raja Inal", "Taufiq"],
            "Dumai": ["Yeni", "Adi", "Badu"],
            "Kuansing": ["Susi", "Adi", "Iqbal"]
        };

        // --- Referensi Elemen DOM ---
        const absenForm = document.getElementById('absen-form');
        const kabupatenSelect = document.getElementById('kabupaten');
        const namaSelect = document.getElementById('nama');
        const jenisPresensiSelect = document.getElementById('jenis-presensi');
        const btnKirim = document.getElementById('btn-kirim');
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        const notifModal = document.getElementById('notif-modal');
        const notifTitle = document.getElementById('notif-title');
        const notifMessage = document.getElementById('notif-message');
        const btnCloseModal = document.getElementById('btn-close-modal');


        // --- FUNGSI TAMPILKAN/SEMBUNYIKAN MODAL ---
        function showModal(title, message, isSuccess = true) {
            notifTitle.textContent = title;
            notifMessage.textContent = message;
            
            // Ubah warna tombol berdasarkan sukses/error
            if (isSuccess) {
                notifTitle.classList.remove('text-red-600');
                notifTitle.classList.add('text-gray-800');
                btnCloseModal.classList.remove('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500');
                btnCloseModal.classList.add('bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-500');
            } else {
                notifTitle.classList.add('text-red-600');
                notifTitle.classList.remove('text-gray-800');
                btnCloseModal.classList.add('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500');
                btnCloseModal.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-500');
            }
            
            notifModal.classList.add('visible');
            notifModal.classList.remove('hidden');
        }

        btnCloseModal.addEventListener('click', () => {
            notifModal.classList.remove('visible');
            notifModal.classList.add('hidden');
        });
        
        // --- FUNGSI LOADING ---
        function showLoading(message) {
            loadingText.textContent = message;
            loadingOverlay.classList.remove('hidden');
        }
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }


        // --- LOGIKA DROPDOWN DINAMIS ---
        kabupatenSelect.addEventListener('change', () => {
            const selectedKabupaten = kabupatenSelect.value;
            
            // Kosongkan daftar nama
            namaSelect.innerHTML = ''; 
            
            if (selectedKabupaten && pimpinanData[selectedKabupaten]) {
                namaSelect.disabled = false;
                namaSelect.innerHTML = '<option value="">-- Pilih Nama --</option>'; // Tambah placeholder
                
                pimpinanData[selectedKabupaten].forEach(nama => {
                    const option = document.createElement('option');
                    option.value = nama;
                    option.textContent = nama;
                    namaSelect.appendChild(option);
                });
            } else {
                namaSelect.disabled = true;
                namaSelect.innerHTML = '<option value="">-- Pilih Kabupaten Dulu --</option>';
            }
        });

        // --- LOGIKA UTAMA SUBMIT FORM ---
        absenForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (SCRIPT_URL === "MASUKKAN_URL_GOOGLE_APPS_SCRIPT_ANDA_DI_SINI") {
                 showModal('Error Konfigurasi', 'URL Google Apps Script belum diatur di file absen.html.', false);
                 return;
            }
            
            showLoading('Mengecek lokasi GPS...');
            
            const formData = {
                kabupaten: kabupatenSelect.value,
                nama: namaSelect.value,
                jenis: jenisPresensiSelect.value
            };
            
            // 1. Panggil fungsi Geolocation
            if (!navigator.geolocation) {
                hideLoading();
                showModal('Error GPS', 'Browser Anda tidak mendukung Geolocation.', false);
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => { // Sukses mendapatkan lokasi
                    checkLocationAndSubmit(position, formData);
                },
                (error) => { // Gagal mendapatkan lokasi
                    hideLoading();
                    handleGPSError(error);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

        // 2. Fungsi Cek Lokasi dan Submit
        function checkLocationAndSubmit(position, formData) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;

            // Hitung jarak
            const distance = calculateDistance(userLat, userLon, TARGET_LAT, TARGET_LON);
            
            if (distance <= MAX_DISTANCE_METERS) {
                // LOKASI SESUAI
                showLoading('Lokasi terverifikasi. Mengirim data...');
                submitToGoogleSheet(formData);
            } else {
                // LOKASI JAUH
                hideLoading();
                showModal(
                    'Lokasi Tidak Sesuai',
                    `Anda saat ini tidak dapat melakukan absensi karena berada ${distance.toFixed(0)} meter dari titik lokasi kantor.`,
                    false
                );
            }
        }

        // 3. Fungsi Kirim Data ke Google Sheet
        async function submitToGoogleSheet(formData) {
            try {
                // Menggunakan fetch dengan method POST
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', // Diperlukan untuk Apps Script
                    redirect: "follow",
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8", // Apps Script doPost seringkali lebih mudah menerima text/plain
                    },
                    body: JSON.stringify(formData) // Kirim data sebagai string JSON
                });

                const result = await response.json();
                hideLoading();

                if (result.status === 'success') {
                    const tgl = new Date().toLocaleDateString('id-ID', { dateStyle: 'long' });
                    showModal(
                        'Absensi Berhasil',
                        `Absensi '${formData.jenis}' pada ${tgl} telah dikirim.`
                    );
                    absenForm.reset(); // Reset form
                    // Reset dropdown nama
                    namaSelect.disabled = true;
                    namaSelect.innerHTML = '<option value="">-- Pilih Kabupaten Dulu --</option>';
                } else {
                    // Tampilkan error dari Apps Script (misal: "Sudah absen masuk")
                    showModal('Error', result.message || 'Gagal mengirim data.', false);
                }
            } catch (error) {
                hideLoading();
                console.error('Error submitting data:', error);
                showModal('Error Jaringan', 'Terjadi masalah saat mengirim data. Coba lagi.', false);
            }
        }
        
        // --- FUNGSI BANTUAN (HELPER) ---

        // Fungsi Error GPS
        function handleGPSError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    showModal('Error GPS', 'Anda menolak izin lokasi. Absensi tidak dapat dilanjutkan.', false);
                    break;
                case error.POSITION_UNAVAILABLE:
                    showModal('Error GPS', 'Informasi lokasi tidak tersedia.', false);
                    break;
                case error.TIMEOUT:
                    showModal('Error GPS', 'Waktu permintaan lokasi habis. Coba lagi.', false);
                    break;
                default:
                    showModal('Error GPS', 'Terjadi kesalahan tidak diketahui saat mengambil lokasi.', false);
                    break;
            }
        }

        // Fungsi Haversine untuk menghitung jarak 2 titik GPS (dalam meter)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radius bumi dalam meter
            
            const phi1 = lat1 * Math.PI / 180; // konversi ke radian
            const phi2 = lat2 * Math.PI / 180;
            const deltaPhi = (lat2 - lat1) * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
                      
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // Jarak dalam meter
            return d;
        }

    </script>
</body>
</html>
