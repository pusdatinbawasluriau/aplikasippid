<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Bawaslu Riau</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Menggunakan font Inter sebagai default */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Menyembunyikan ikon kalender default pada input tanggal */
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }

        /* Style untuk tombol radio kustom */
        .radio-custom {
            display: none;
        }
        .radio-custom + label {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb; /* border-gray-200 */
            transition: all 0.2s;
            font-weight: 500;
        }
        .radio-custom:checked + label {
            background-color: #fb923c; /* bg-orange-400 */
            border-color: #f97316; /* border-orange-500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Style untuk input file kustom */
        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1rem;
            background-color: #f3f4f6; /* bg-gray-100 */
            border: 2px dashed #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .file-input-label:hover {
            background-color: #e5e7eb; /* bg-gray-200 */
            border-color: #9ca3af; /* border-gray-400 */
        }
        .file-input-label svg {
            margin-right: 0.5rem;
        }

        /* Modal (Pop-up) styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-out;
        }
        .modal.flex { /* State 'flex' akan ditambahkan oleh JS untuk 'show' */
            transform: scale(1);
            opacity: 1;
        }
        .modal.flex .modal-content {
            transform: scale(1);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl overflow-hidden">
            <!-- Header Oranye -->
            <div class="bg-orange-500 p-6">
                <h1 class="text-2xl font-bold text-white text-center">
                    Aplikasi Absensi
                </h1>
                <p class="text-center text-orange-100 text-sm mt-1">
                    Bawaslu Provinsi Riau
                </p>
            </div>

            <!-- Konten Form -->
            <form id="absensiForm" class="p-6 md:p-8 space-y-6">
                
                <div class="text-center">
                    <h2 class="text-xl font-semibold text-gray-800">Selamat Datang</h2>
                    <p class="text-gray-500 text-sm">Silakan isi data absensi Anda.</p>
                </div>

                <!-- Pilihan Kabupaten -->
                <div>
                    <label for="kabupaten" class="block text-sm font-medium text-gray-700 mb-1">Kabupaten</label>
                    <select id="kabupaten" name="kabupaten" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="" disabled selected>Pilih Kabupaten/Kota...</option>
                        <option value="Pekanbaru">Pekanbaru</option>
                        <option value="Dumai">Dumai</option>
                        <option value="Kuansing">Kuansing</option>
                        <option value="Rokan Hulu">Rokan Hulu</option>
                        <option value="Rokan Hilir">Rokan Hilir</option>
                        <option value="Indragiri Hulu">Indragiri Hulu</option>
                        <option value="Indragiri Hilir">Indragiri Hilir</option>
                        <option value="Kampar">Kampar</option>
                        <option value="Siak">Siak</option>
                        <option value="Bengkalis">Bengkalis</option>
                        <option value="Kep. Meranti">Kep. Meranti</option>
                        <option value="Pelalawan">Pelalawan</option>
                    </select>
                </div>

                <!-- Pilihan Nama Pimpinan -->
                <div>
                    <label for="namaPimpinan" class="block text-sm font-medium text-gray-700 mb-1">Nama Pimpinan</label>
                    <select id="namaPimpinan" name="namaPimpinan" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                        disabled>
                        <option value="">Pilih kabupaten terlebih dahulu...</option>
                    </select>
                </div>

                <!-- Pilihan Jenis Presensi -->
                <div>
                    <span class="block text-sm font-medium text-gray-700 mb-2">Jenis Presensi</span>
                    <div class="flex gap-4">
                        <input type="radio" id="presensiMasuk" name="jenisPresensi" value="Masuk" class="radio-custom" required>
                        <label for="presensiMasuk" class="flex-1 text-center">Masuk</label>

                        <input type="radio" id="presensiPulang" name="jenisPresensi" value="Pulang" class="radio-custom">
                        <label for="presensiPulang" class="flex-1 text-center">Pulang</label>
                    </div>
                </div>

                <!-- Upload Foto Selfie -->
                <div>
                    <span class="block text-sm font-medium text-gray-700 mb-1">Foto Selfie</span>
                    <!-- Atribut 'capture="user"' akan memprioritaskan kamera depan di HP -->
                    <input type="file" id="fotoSelfie" name="fotoSelfie" accept="image/*" capture="user" class="hidden" required>
                    <label for="fotoSelfie" class="file-input-label" id="fileLabel">
                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span id="fileLabelText">Ambil Foto Selfie</span>
                    </label>
                    <!-- Preview Gambar -->
                    <img id="preview" class="hidden mt-4 rounded-lg shadow-md w-full h-auto object-cover" alt="Preview Foto Selfie">
                </div>

                <!-- Tombol Kirim -->
                <button type="submit" id="submitButton"
                    class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-orange-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-50 disabled:opacity-50">
                    <span id="buttonText">Kirim Absensi</span>
                    <span id="buttonSpinner" class="hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Memproses...
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- Modal (Pop-up) -->
    <div id="modal" class="modal">
        <div class="modal-content text-center">
            <div id="modalIcon">
                <!-- Ikon akan disisipkan oleh JS -->
            </div>
            <h3 id="modalTitle" class="text-lg font-medium leading-6 text-gray-900 mt-2"></h3>
            <div class="mt-2">
                <p id="modalMessage" class="text-sm text-gray-600"></p>
            </div>
            <div class="mt-5">
                <button type="button" id="modalCloseButton"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-orange-500 text-base font-medium text-white hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 sm:text-sm">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI APLIKASI ---
        // !!! PENTING: Ganti URL ini dengan URL Web App Google Apps Script Anda
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwMNQlYQ153HCjX7PShMLNm_jh1hHVaaVyK2Thswf73Z0iNYqU5MKwpVg7h5_fWdmM0/exec";

        // --- Data Pimpinan dan Koordinat ---
        const pimpinanData = {
            "Pekanbaru": ["Ferdy", "Misbah Ibrahim", "Reni Purba", "Raja Inal Dalimunthe", "Taufik Hidayat"],
            "Dumai": ["Agustri", "Yosi Renaldi", "Yeni Kartini"],
            "Kuansing": ["Ade Indra Sakti", "Nur Afni", "Mardius Adi Saputra"],
            "Rokan Hulu": ["Fajrul Islami Damsir", "Gummer Siregar", "Yurnalis", "Wikki Yuliandra", "Safrizal Hasbi"],
            "Rokan Hilir": ["Zubaidah", "Jaka Abdillah", "Nasrudin", "Dedi Sibuae", "Nurmaidani"],
            "Indragiri Hulu": ["Dedi Risanto", "Dwi Apriansyah Indra", "M.Lukman Said", "Said M Affandi", "Salestia Deni"],
            "Indragiri Hilir": ["Rustam", "Rahmaddian", "Abus Siraj", "Indra", "Musdalifa"],
            "Kampar": ["Syawir Abdullah", "Miki AB", "Mustaqim Akbar", "Fadriansyah", "Mhd. Amin S"],
            "Siak": ["Zulfadli Nugraha", "Ahmad Dardiri", "Harlen Manurung", "M.Andi Susilawan", "Ikhsan Parulian Harap"],
            "Bengkalis": ["Usman", "Budi Kurnialis", "Andi Setiawan", "Arsi Suprianto", "Mendra"],
            "Kep. Meranti": ["Syamsurizal", "Rio Andika", "M. Hafit"],
            "Pelalawan": ["Andrizal", "Bambang Sugi Hartono", "Syakir Hamdani", "Ari Nugroho Susanto", "Ruda Nur Kisawan"]
        };

        const koordinatKantor = {
            "Pekanbaru": { lat: 0.4626240836716061, lon: 101.42461679999998 },
            "Dumai": { lat: 1.6630254508232711, lon: 101.45249334765391 },
            "Kuansing": { lat: -0.534470, lon: 101.569874 },
            "Rokan Hulu": { lat: 0.876158, lon: 100.286686 },
            "Rokan Hilir": { lat: 2.158803, lon: 100.799874 },
            "Indragiri Hulu": { lat: 2.158803, lon: 100.799874 }, // Data sama dengan Rohil?
            "Indragiri Hilir": { lat: -0.3201440, lon: 103.1542940 },
            "Kampar": { lat: 0.324784, lon: 101.026305 },
            "Siak": { lat: 0.814464, lon: 102.018998 },
            "Bengkalis": { lat: 1.473969, lon: 102.123841 },
            "Kep. Meranti": { lat: 1.008499, lon: 102.712468 },
            "Pelalawan": { lat: 2.158803, lon: 100.799874 } // Data sama dengan Rohil?
        };

        // --- Elemen DOM ---
        const form = document.getElementById('absensiForm');
        const kabupatenSelect = document.getElementById('kabupaten');
        const pimpinanSelect = document.getElementById('namaPimpinan');
        const fotoInput = document.getElementById('fotoSelfie');
        const preview = document.getElementById('preview');
        const fileLabelText = document.getElementById('fileLabelText');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalIcon = document.getElementById('modalIcon');
        const modalCloseButton = document.getElementById('modalCloseButton');

        // --- Logika Modal (Pop-up) ---
        const iconSuccess = `<svg class="h-12 w-12 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        const iconError = `<svg class="h-12 w-12 text-red-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        const iconInfo = `<svg class="h-12 w-12 text-blue-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

        function showModal(title, message, type = 'info') {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // innerHTML agar bisa render jarak
            
            if (type === 'success') modalIcon.innerHTML = iconSuccess;
            else if (type === 'error') modalIcon.innerHTML = iconError;
            else modalIcon.innerHTML = iconInfo;

            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('flex'), 10); // Untuk transisi
        }

        modalCloseButton.addEventListener('click', () => {
            modal.classList.remove('flex');
            setTimeout(() => modal.style.display = 'none', 200);
        });

        // --- Logika Form ---

        // 1. Update Pilihan Pimpinan berdasarkan Kabupaten
        kabupatenSelect.addEventListener('change', () => {
            const selectedKabupaten = kabupatenSelect.value;
            const pimpinanList = pimpinanData[selectedKabupaten] || [];

            pimpinanSelect.innerHTML = ''; // Kosongkan pilihan
            
            if (pimpinanList.length > 0) {
                pimpinanSelect.disabled = false;
                pimpinanSelect.add(new Option('Pilih Nama Pimpinan...', ''));
                pimpinanList.forEach(nama => {
                    pimpinanSelect.add(new Option(nama, nama));
                });
            } else {
                pimpinanSelect.disabled = true;
                pimpinanSelect.add(new Option('Pilih kabupaten terlebih dahulu...', ''));
            }
        });

        // 2. Tampilkan Preview Foto
        fotoInput.addEventListener('change', () => {
            const file = fotoInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    fileLabelText.textContent = file.name; // Tampilkan nama file
                }
                reader.readAsDataURL(file);
            }
        });

        // 3. Handle Submit Form
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (GAS_WEB_APP_URL === "URL_GAS_ANDA_DI_SINI") {
                showModal('Kesalahan Konfigurasi', 'Harap masukkan URL Google Apps Script yang valid di file index.html.', 'error');
                return;
            }

            setLoading(true);

            // --- Ambil Data Form ---
            const formData = new FormData(form);
            const kabupaten = formData.get('kabupaten');
            const nama = formData.get('namaPimpinan');
            const jenisPresensi = formData.get('jenisPresensi');
            const file = formData.get('fotoSelfie');

            // --- Validasi Sederhana ---
            if (!kabupaten || !nama || !jenisPresensi || !file) {
                showModal('Data Tidak Lengkap', 'Mohon lengkapi semua isian form.', 'error');
                setLoading(false);
                return;
            }
            
            // --- Cek Anti-Fraud (localStorage) ---
            const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
            const storageKey = `absensi_${today}_${nama}_${jenisPresensi}`;
            
            if (localStorage.getItem(storageKey)) {
                showModal('Absensi Berulang', 'Anda terdeteksi melakukan absensi berulang (<b>' + jenisPresensi + '</b>) pada hari ini. Silakan coba lagi besok.', 'error');
                setLoading(false);
                return;
            }

            try {
                // --- Cek Lokasi GPS ---
                showModal('Mendapatkan Lokasi', 'Mohon tunggu, sedang mengambil titik koordinat GPS Anda...', 'info');
                const coords = await getCoordinates();
                const targetCoords = koordinatKantor[kabupaten];
                
                if (!targetCoords) {
                     showModal('Kesalahan Data', `Koordinat untuk ${kabupaten} tidak ditemukan.`, 'error');
                     setLoading(false);
                     return;
                }

                const distance = calculateDistance(coords.latitude, coords.longitude, targetCoords.lat, targetCoords.lon);
                
                // --- Cek Jarak (100 meter) ---
                if (distance > 100) {
                    showModal('Lokasi Terlalu Jauh', `Anda saat ini tidak dapat melakukan absensi karena berada <b>${distance.toFixed(0)} meter</b> dari titik lokasi kantor.`, 'error');
                    setLoading(false);
                    return;
                }

                // --- Lolos Pengecekan, Kirim Data ---
                showModal('Mengirim Data', 'Lokasi terverifikasi. Mengirim data absensi Anda...', 'info');

                const base64Image = await toBase64(file);

                const payload = {
                    kabupaten: kabupaten,
                    nama: nama,
                    jenisPresensi: jenisPresensi,
                    mimeType: file.type,
                    // Kirim hanya data base64-nya, tanpa prefix "data:image/jpeg;base64,"
                    base64Image: base64Image.split(',')[1]
                };

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors', // Diperlukan untuk request cross-origin
                    redirect: 'follow',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // GAS seringkali lebih suka text/plain
                    }
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    // Tandai di localStorage
                    localStorage.setItem(storageKey, 'true');
                    const tglSukses = new Date().toLocaleDateString('id-ID', { dateStyle: 'full' });
                    showModal('Absensi Berhasil', `Absensi <b>${jenisPresensi}</b> atas nama <b>${nama}</b> pada <b>${tglSukses}</b> telah dikirim.`, 'success');
                    form.reset();
                    preview.classList.add('hidden');
                    fileLabelText.textContent = 'Ambil Foto Selfie';
                    pimpinanSelect.innerHTML = '<option value="">Pilih kabupaten terlebih dahulu...</option>';
                    pimpinanSelect.disabled = true;
                } else {
                    throw new Error(result.message || 'Terjadi kesalahan di server.');
                }

            } catch (error) {
                showModal('Terjadi Kesalahan', error.message, 'error');
            } finally {
                setLoading(false);
            }
        });


        // --- Fungsi Helper ---

        // Mengubah status loading tombol
        function setLoading(isLoading) {
            submitButton.disabled = isLoading;
            if (isLoading) {
                buttonText.classList.add('hidden');
                buttonSpinner.classList.remove('hidden');
            } else {
                buttonText.classList.remove('hidden');
                buttonSpinner.classList.add('hidden');
            }
        }

        // Mendapatkan koordinat GPS (Promise)
        function getCoordinates() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation tidak didukung oleh browser Anda.'));
                }
                
                // enableHighAccuracy: true -> meminta GPS terbaik
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve(position.coords);
                    },
                    (error) => {
                        let errorMsg = 'Gagal mendapatkan lokasi: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg += "Anda menolak izin lokasi.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg += "Informasi lokasi tidak tersedia.";
                                break;
                            case error.TIMEOUT:
                                errorMsg += "Waktu permintaan lokasi habis.";
                                break;
                            default:
                                errorMsg += "Terjadi kesalahan tidak diketahui.";
                        }
                        reject(new Error(errorMsg));
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            });
        }

        // Menghitung jarak (Haversine Formula) -> hasil dalam meter
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radius bumi dalam meter
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Jarak dalam meter
        }

        // Konversi File ke Base64 (Promise)
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

    </script>
</body>
</html>
