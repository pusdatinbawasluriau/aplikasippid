<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Bawaslu Riau</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Style untuk loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto max-w-lg p-4 min-h-screen flex flex-col justify-center">
        <div class="bg-white shadow-lg rounded-xl p-6 space-y-5">
            
            <!-- Judul -->
            <div class="text-center">
                <!-- Logo Bawaslu Asli -->
                <img src="https://riau.bawaslu.go.id/wp-content/uploads/2022/07/Logo-Bawaslu-Baru-2022-Warna.png" 
                     alt="Logo Bawaslu" 
                     class="mx-auto mb-3"
                     style="width: 100px; height: auto;"
                     onerror="this.src='https://placehold.co/100x100/E2E8F0/333?text=Logo+Bawaslu'">
                
                <h1 class="text-2xl font-bold text-gray-800">
                    Selamat Datang di Aplikasi Absensi
                </h1>
                <p class="text-lg text-gray-600">Bawaslu Provinsi Riau</p>
            </div>

            <!-- Form Absensi -->
            <form id="absensiForm" class="space-y-4">
                
                <!-- Pilihan Kabupaten -->
                <div>
                    <label for="kabupaten" class="block text-sm font-medium text-gray-700 mb-1">Pilih Kabupaten/Kota</label>
                    <select id="kabupaten" name="kabupaten" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Pilih Kabupaten/Kota --</option>
                        <option value="Pekanbaru">Pekanbaru</option>
                        <option value="Dumai">Dumai</option>
                        <option value="Kuansing">Kuansing</option>
                        <option value="Rokan Hulu">Rokan Hulu</option>
                        <option value="Rokan Hilir">Rokan Hilir</option>
                        <option value="Indragiri Hulu">Indragiri Hulu</option>
                        <option value="Indragiri Hilir">Indragiri Hilir</option>
                        <option value="Kampar">Kampar</option>
                        <option value="Siak">Siak</option>
                        <option value="Bengkalis">Bengkalis</option>
                        <option value="Kep. Meranti">Kep. Meranti</option>
                        <option value="Pelalawan">Pelalawan</option>
                    </select>
                </div>

                <!-- Pilihan Nama Pimpinan -->
                <div>
                    <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Pimpinan</label>
                    <select id="nama" name="nama" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                        <option value="">-- Pilih Nama --</option>
                    </select>
                </div>

                <!-- Pilihan Presensi -->
                <div>
                    <label for="presensi" class="block text-sm font-medium text-gray-700 mb-1">Jenis Presensi</label>
                    <select id="presensi" name="presensi" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Pilih Jenis Presensi --</option>
                        <option value="Presensi Masuk">Presensi Masuk</option>
                        <option value="Presensi Pulang">Presensi Pulang</option>
                    </select>
                </div>

                <!-- Ambil Foto Selfie -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ambil Foto Selfie</label>
                    <div id="cameraContainer" class="bg-gray-200 rounded-lg overflow-hidden">
                        <video id="video" class="w-full h-auto" playsinline autoplay muted></video>
                    </div>
                    <canvas id="canvas" class="hidden"></canvas>
                    <div id="previewContainer" class="hidden mt-2">
                        <img id="selfiePreview" class="w-full h-auto rounded-lg" alt="Preview Selfie">
                    </div>
                    <div class="flex gap-2 mt-2">
                         <button type="button" id="snap" class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                             Ambil Foto
                         </button>
                         <button type="button" id="retake" class="w-full py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 hidden">
                             Ganti Foto
                         </button>
                    </div>
                </div>

                <!-- Tombol Kirim -->
                <button type="submit" id="kirim" class="w-full py-3 px-4 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 flex items-center justify-center gap-2" disabled>
                    <span id="kirimText">Kirim Absensi</span>
                    <div id="loader" class="loader hidden"></div>
                </button>
            </form>

            <!-- Status Message -->
            <div id="status" class="text-center text-sm font-medium p-3 rounded-lg hidden"></div>
        </div>
    </div>

    <script>
        // ---------------------------------------------------------------------
        // KONFIGURASI
        // ---------------------------------------------------------------------
        // !!! GANTI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA SETELAH DEPLOY !!!
        // URL INI DIDAPAT SETELAH ANDA MEN-DEPLOY FILE Code.gs
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyhVzUnQaShScG-bbZxBzOyVGdG-jKvuqh2fC7mbISrEeJOeqDBKxCHDGoU0K_zLLnO/exec';
        // ---------------------------------------------------------------------

        // Data Pimpinan dan Lokasi
        const pimpinanData = {
            'Pekanbaru': ['Ferdy', 'Misbah Ibrahim', 'Reni Purba', 'Raja Inal Dalimunthe', 'Taufik Hidayat'],
            'Dumai': ['Agustri', 'Yosi Renaldi', 'Yeni Kartini'],
            'Kuansing': ['Ade Indra Sakti', 'Nur Afni', 'Mardius Adi Saputra'],
            'Rokan Hulu': ['Fajrul Islami Damsir', 'Gummer Siregar', 'Yurnalis', 'Wikki Yuliandra', 'Safrizal Hasbi'],
            'Rokan Hilir': ['Zubaidah', 'Jaka Abdillah', 'Nasrudin', 'Dedi Sibuae', 'Nurmaidani'],
            'Indragiri Hulu': ['Dedi Risanto', 'Dwi Apriansyah Indra', 'M.Lukman Said', 'Said M Affandi', 'Salestia Deni'],
            'Indragiri Hilir': ['Rustam', 'Rahmaddian', 'Abus Siraj', 'Indra', 'Musdalifa'],
            'Kampar': ['Syawir Abdullah', 'Miki AB', 'Mustaqim Akbar', 'Fadriansyah', 'Mhd. Amin S'],
            'Siak': ['Zulfadli Nugraha', 'Ahmad Dardiri', 'Harlen Manurung', 'M.Andi Susilawan', 'Ikhsan Parulian Harap'],
            'Bengkalis': ['Usman', 'Budi Kurnialis', 'Andi Setiawan', 'Arsi Suprianto', 'Mendra'],
            'Kep. Meranti': ['Syamsurizal', 'Rio Andika', 'M. Hafit'],
            'Pelalawan': ['Andrizal', 'Bambang Sugi Hartono', 'Syakir Hamdani', 'Ari Nugroho Susanto', 'Ruda Nur Kisawan']
        };

        const lokasiKantor = {
            'Pekanbaru': { lat: 0.5228952, lon: 101.4429202 },
            'Dumai': { lat: 1.6630254508232711, lon: 101.45249334765391 },
            'Kuansing': { lat: -0.534470, lon: 101.569874 },
            'Rokan Hulu': { lat: 0.876158, lon: 100.286686 },
            'Rokan Hilir': { lat: 2.158803, lon: 100.799874 },
            'Indragiri Hulu': { lat: -0.334796, lon: 102.321204 }, 
            'Indragiri Hilir': { lat: -0.3201440, lon: 103.1542940 },
            'Kampar': { lat: 0.324784, lon: 101.026305 },
            'Siak': { lat: 0.814464, lon: 102.018998 },
            'Bengkalis': { lat: 1.473969, lon: 102.123841 },
            'Kep. Meranti': { lat: 1.008499, lon: 102.712468 },
            'Pelalawan': { lat: 0.353316, lon: 101.884210 }
        };

        // Referensi Elemen DOM
        const form = document.getElementById('absensiForm');
        const kabupatenSelect = document.getElementById('kabupaten');
        const namaSelect = document.getElementById('nama');
        const presensiSelect = document.getElementById('presensi');
        const kirimButton = document.getElementById('kirim');
        const kirimText = document.getElementById('kirimText');
        const loader = document.getElementById('loader');
        const statusDiv = document.getElementById('status');
        
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snapButton = document.getElementById('snap');
        const retakeButton = document.getElementById('retake');
        const previewContainer = document.getElementById('previewContainer');
        const selfiePreview = document.getElementById('selfiePreview');
        const cameraContainer = document.getElementById('cameraContainer');

        let selfieData = null;

        // Inisialisasi Kamera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }, // Paksa kamera depan
                    audio: false 
                });
                video.srcObject = stream;
                video.play();
                snapButton.disabled = false;
                checkFormCompleteness();
            } catch (err) {
                console.error("Error accessing camera: ", err);
                showStatus('Gagal mengakses kamera. Pastikan Anda memberikan izin.', 'error');
            }
        }

        // Ambil Foto
        snapButton.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            
            // Balik gambar secara horizontal (mirror)
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            selfieData = canvas.toDataURL('image/jpeg', 0.8); // Kompresi gambar
            selfiePreview.src = selfieData;

            // Tampilkan preview, sembunyikan video
            cameraContainer.classList.add('hidden');
            previewContainer.classList.remove('hidden');
            snapButton.classList.add('hidden');
            retakeButton.classList.remove('hidden');
            checkFormCompleteness();
        });

        // Ulangi Ambil Foto
        retakeButton.addEventListener('click', () => {
            selfieData = null;
            selfiePreview.src = '';

            // Tampilkan video, sembunyikan preview
            cameraContainer.classList.remove('hidden');
            previewContainer.classList.add('hidden');
            snapButton.classList.remove('hidden');
            retakeButton.classList.add('hidden');
            checkFormCompleteness();
        });

        // Update Pilihan Nama Pimpinan berdasarkan Kabupaten
        kabupatenSelect.addEventListener('change', () => {
            const selectedKabupaten = kabupatenSelect.value;
            namaSelect.innerHTML = '<option value="">-- Pilih Nama --</option>'; // Reset

            if (selectedKabupaten && pimpinanData[selectedKabupaten]) {
                namaSelect.disabled = false;
                pimpinanData[selectedKabupaten].forEach(nama => {
                    const option = document.createElement('option');
                    option.value = nama;
                    option.textContent = nama;
                    namaSelect.appendChild(option);
                });
            } else {
                namaSelect.disabled = true;
            }
            checkFormCompleteness();
        });

        // Cek Kelengkapan Form
        function checkFormCompleteness() {
            const isComplete = kabupatenSelect.value &&
                               namaSelect.value &&
                               presensiSelect.value &&
                               selfieData;
            kirimButton.disabled = !isComplete;
        }

        // Tambahkan listener ke form inputs
        [kabupatenSelect, namaSelect, presensiSelect].forEach(el => {
            el.addEventListener('change', checkFormCompleteness);
        });

        // Fungsi Haversine untuk menghitung jarak
        function getDistance(lat1, lon1, lat2, lon2) {
            function toRad(x) {
                return x * Math.PI / 180;
            }
            const R = 6371; // Radius bumi dalam km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            return d * 1000; // Jarak dalam meter
        }

        // Tampilkan Status
        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            
            if (type === 'error') {
                statusDiv.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                statusDiv.classList.add('bg-green-100', 'text-green-700');
            } else {
                statusDiv.classList.add('bg-yellow-100', 'text-yellow-700');
            }
        }

        // Set Loading State
        function setLoading(isLoading) {
            if (isLoading) {
                kirimButton.disabled = true;
                kirimText.classList.add('hidden');
                loader.classList.remove('hidden');
                statusDiv.classList.add('hidden');
            } else {
                kirimButton.disabled = false;
                kirimText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        // Handler Submit Form
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (GAS_WEB_APP_URL === 'URL_WEB_APP_ANDA_DISINI' || GAS_WEB_APP_URL === '') {
                showStatus('Harap konfigurasi URL Web App di file index.html terlebih dahulu.', 'error');
                return;
            }

            setLoading(true);
            showStatus('Mendapatkan lokasi GPS Anda...', 'info');

            // 1. Dapatkan Lokasi GPS
            if (!navigator.geolocation) {
                showStatus('Geolocation tidak didukung oleh browser Anda.', 'error');
                setLoading(false);
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    
                    const selectedKabupaten = kabupatenSelect.value;
                    const kantorLok = lokasiKantor[selectedKabupaten];

                    // 2. Cek Geofencing
                    const distance = getDistance(userLat, userLon, kantorLok.lat, kantorLok.lon);

                    if (distance > 100) { // Batas 100 meter
                        showStatus(`Anda saat ini tidak dapat melakukan absensi karena berada ${distance.toFixed(0)} meter dari titik lokasi kantor.`, 'error');
                        setLoading(false);
                        return;
                    }

                    // 3. Lokasi Sesuai, Lanjutkan Pengiriman
                    showStatus('Lokasi terverifikasi. Mengirim data absensi...', 'info');
                    sendDataToGAS(userLat, userLon);
                },
                (error) => {
                    let errorMsg = 'Gagal mendapatkan lokasi GPS. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += "Anda menolak izin lokasi.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += "Informasi lokasi tidak tersedia.";
                            break;
                        case error.TIMEOUT:
                            errorMsg += "Waktu permintaan lokasi habis.";
                            break;
                        default:
                            errorMsg += "Terjadi kesalahan tidak diketahui.";
                            break;
                    }
                    showStatus(errorMsg, 'error');
                    setLoading(false);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

        // 4. Fungsi Kirim Data ke Google Apps Script
        async function sendDataToGAS(latitude, longitude) {
            const payload = {
                kabupaten: kabupatenSelect.value,
                nama: namaSelect.value,
                presensi: presensiSelect.value,
                timestamp: new Date().toISOString(), // Kirim ISO string, GAS akan format
                gps: { lat: latitude, lon: longitude },
                imageData: selfieData // Ini adalah base64 string
            };

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors', // Penting untuk cross-origin request
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Kirim sebagai text plain
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showStatus(result.message, 'success');
                    // Reset form
                    form.reset();
                    namaSelect.innerHTML = '<option value="">-- Pilih Nama --</option>';
                    namaSelect.disabled = true;
                    retakeButton.click(); // Reset kamera
                    checkFormCompleteness();
                } else {
                    // Tampilkan error dari server (misal: duplikat)
                    showStatus(result.message, 'error');
                }

            } catch (error) {
                console.error('Error sending data:', error);
                // Pesan error spesifik yang diminta
                showStatus('Gagal mengirim data. Cek koneksi internet Anda.', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Mulai kamera saat halaman dimuat
        window.addEventListener('load', startCamera);
        // Cek kelengkapan form saat awal
        checkFormCompleteness();

    </script>
</body>
</html>
