<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Bawaslu Riau</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom style untuk loading overlay */
        #loading-overlay {
            display: none; /* Sembunyi secara default */
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 50;
            color: white;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #loading-overlay.flex {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto max-w-lg p-4">
        <div class="bg-white shadow-xl rounded-lg p-6 my-8">
            
            <header class="text-center mb-6">
                <h1 class="text-2xl font-bold text-indigo-700">Selamat Datang!</h1>
                <p class="text-gray-600">Aplikasi Absensi Bawaslu Provinsi Riau</p>
            </header>

            <form id="presensi-form">
                <!-- 1. Pilih Kabupaten -->
                <div class="mb-4">
                    <label for="select-kabupaten" class="block text-sm font-medium text-gray-700 mb-1">Kabupaten</label>
                    <select id="select-kabupaten" name="kabupaten" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <option value="">-- Pilih Kabupaten --</option>
                        <!-- Opsi diisi oleh JavaScript -->
                    </select>
                </div>
                
                <!-- 2. Pilih Nama -->
                <div class="mb-4">
                    <label for="select-nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Pimpinan</label>
                    <select id="select-nama" name="nama" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500" required disabled>
                        <option value="">-- Pilih Kabupaten Dulu --</option>
                    </select>
                </div>
                
                <!-- 3. Jenis Presensi -->
                <div class="mb-4">
                    <label for="select-presensi" class="block text-sm font-medium text-gray-700 mb-1">Jenis Presensi</label>
                    <select id="select-presensi" name="presensi" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <option value="">-- Pilih Jenis Presensi --</option>
                        <option value="Masuk">Presensi Masuk</option>
                        <option value="Pulang">Presensi Pulang</option>
                    </select>
                </div>

                <!-- 4. Upload Foto Selfie -->
                <div class="mb-6">
                    <label for="foto-selfie" class="block text-sm font-medium text-gray-700 mb-1">Foto Selfie</label>
                    <!-- 
                        PENTING: 
                        'capture="user"' memaksa penggunaan kamera depan.
                        'accept="image/*"' hanya menerima gambar.
                    -->
                    <input type="file" id="foto-selfie" name="foto" accept="image/*" capture="user" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-50 file:text-indigo-700
                        hover:file:bg-indigo-100" required>
                    <p class="text-xs text-gray-500 mt-1">Akan langsung membuka kamera depan. Tidak bisa upload dari galeri.</p>
                </div>
                
                <!-- 5. Tombol Kirim -->
                <button type="submit" id="kirim-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md font-semibold shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all disabled:bg-gray-400">
                    Kirim Absensi
                </button>
            </form>

            <!-- 6. Area Status/Notifikasi -->
            <div id="status-message" class="mt-6 text-center">
                <!-- Pesan sukses atau error akan muncul di sini -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <svg class="animate-spin h-10 w-10 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-text" class="text-lg">Memproses absensi...</p>
    </div>

    <script>
        // =================================================================
        // PENTING: GANTI URL INI DENGAN URL GOOGLE APPS SCRIPT BARU ANDA
        // =================================================================
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby0F4damBxmTmQIRn1u_dJyJ6f4KDJnHM3YDIH30Mmzy9qB_cJiiXAja1LfqdH3_1yoIg/exec';
        // =================================================================

        // Data Pimpinan per Kabupaten
        const pimpinanData = {
            "Pekanbaru": ["Ferdy", "Misbah Ibrahim", "Reni Purba", "Raja Inal Dalimunthe", "Taufik Hidayat"],
            "Dumai": ["Agustri", "Yosi Renaldi", "Yeni Kartini"],
            "Kuansing": ["Ade Indra Sakti", "Nur Afni", "Mardius Adi Saputra"],
            "Rokan Hulu": ["Fajrul Islami Damsir", "Gummer Siregar", "Yurnalis", "Wikki Yuliandra", "Safrizal Hasbi"],
            "Rokan Hilir": ["Zubaidah", "Jaka Abdillah", "Nasrudin", "Dedi Sibuae", "Nurmaidani"],
            "Indragiri Hulu": ["Dedi Risanto", "Dwi Apriansyah Indra", "M.Lukman Said", "Said M Affandi", "Salestia Deni"],
            "Indragiri Hilir": ["Rustam", "Rahmaddian", "Abus Siraj", "Indra", "Musdalifa"],
            "Kampar": ["Syawir Abdullah", "Miki AB", "Mustaqim Akbar", "Fadriansyah", "Mhd. Amin S"],
            "Siak": ["Zulfadli Nugraha", "Ahmad Dardiri", "Harlen Manurung", "M.Andi Susilawan", "Ikhsan Parulian Harap"],
            "Bengkalis": ["Usman", "Budi Kurnialis", "Andi Setiawan", "Arsi Suprianto", "Mendra"],
            "Kep. Meranti": ["Syamsurizal", "Rio Andika", "M. Hafit"],
            "Pelalawan": ["Andrizal", "Bambang Sugi Hartono", "Syakir Hamdani", "Ari Nugroho Susanto", "Ruda Nur Kisawan"]
        };

        // Data Titik Koordinat Target (Lat, Lng)
        const targetLokasi = {
            "Pekanbaru": { lat: 0.5228952, lng: 101.4429202 },
            "Dumai": { lat: 1.6630254508232711, lng: 101.45249334765391 },
            "Kuansing": { lat: -0.534470, lng: 101.569874 },
            "Rokan Hulu": { lat: 0.876158, lng: 100.286686 },
            "Rokan Hilir": { lat: 2.158803, lng: 100.799874 },
            "Indragiri Hulu": { lat: 2.158803, lng: 100.799874 },
            "Indragiri Hilir": { lat: -0.3201440, lng: 103.1542940 },
            "Kampar": { lat: 0.324784, lng: 101.026305 },
            "Siak": { lat: 0.814464, lng: 102.018998 },
            "Bengkalis": { lat: 1.473969, lng: 102.123841 },
            "Kep. Meranti": { lat: 1.008499, lng: 102.712468 },
            "Pelalawan": { lat: 2.158803, lng: 100.799874 }
        };

        // Elemen DOM
        const form = document.getElementById('presensi-form');
        const selectKabupaten = document.getElementById('select-kabupaten');
        const selectNama = document.getElementById('select-nama');
        const fotoInput = document.getElementById('foto-selfie');
        const kirimBtn = document.getElementById('kirim-btn');
        const statusMessage = document.getElementById('status-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        // Fungsi untuk menampilkan pesan status
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'text-red-600' : 'text-green-600';
        }

        // Fungsi untuk loading overlay
        function showLoading(message) {
            loadingText.textContent = message;
            loadingOverlay.classList.add('flex');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('flex');
        }

        // 1. Isi Dropdown Kabupaten saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            const kabupatenKeys = Object.keys(pimpinanData);
            kabupatenKeys.sort().forEach(kab => {
                const option = document.createElement('option');
                option.value = kab;
                option.textContent = kab;
                selectKabupaten.appendChild(option);
            });
        });

        // 2. Update Dropdown Nama saat Kabupaten berubah
        selectKabupaten.addEventListener('change', () => {
            const selectedKab = selectKabupaten.value;
            selectNama.innerHTML = ''; // Kosongkan
            
            if (selectedKab && pimpinanData[selectedKab]) {
                selectNama.disabled = false;
                selectNama.classList.remove('bg-gray-50');
                
                const optionDefault = document.createElement('option');
                optionDefault.value = "";
                optionDefault.textContent = "-- Pilih Nama --";
                selectNama.appendChild(optionDefault);
                
                pimpinanData[selectedKab].forEach(nama => {
                    const option = document.createElement('option');
                    option.value = nama;
                    option.textContent = nama;
                    selectNama.appendChild(option);
                });
            } else {
                selectNama.disabled = true;
                selectNama.classList.add('bg-gray-50');
                const optionDefault = document.createElement('option');
                optionDefault.value = "";
                optionDefault.textContent = "-- Pilih Kabupaten Dulu --";
                selectNama.appendChild(optionDefault);
            }
        });

        // 3. Handle Form Submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            showStatus(''); // Bersihkan status
            
            // Validasi file (meskipun 'required' sudah ada)
            if (fotoInput.files.length === 0) {
                showStatus('Foto selfie wajib diambil.', true);
                return;
            }

            kirimBtn.disabled = true;
            kirimBtn.textContent = 'Memproses...';
            showLoading('Mendapatkan lokasi GPS Anda...');

            try {
                // 1. Dapatkan Lokasi GPS
                const position = await getGeoLocation();
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;

                showLoading('Menghitung jarak ke kantor...');
                
                // 2. Dapatkan data form
                const formData = new FormData(form);
                const kabupaten = formData.get('kabupaten');
                
                // 3. Validasi Jarak (Geofencing)
                const target = targetLokasi[kabupaten];
                if (!target) {
                    throw new Error('Data lokasi untuk kabupaten tidak ditemukan.');
                }

                const distance = getDistance(userLat, userLng, target.lat, target.lng);
                
                if (distance > 100) { // Batas 100 meter
                    throw new Error(`Anda saat ini tidak dapat melakukan absensi karena berada ${distance.toFixed(0)} meter dari titik lokasi kantor.`);
                }
                
                // 4. Lolos Geofence -> Proses Foto dan Kirim
                showLoading('Mengupload foto dan mengirim data...');
                const fotoFile = fotoInput.files[0];
                const base64Foto = await toBase64(fotoFile);

                const payload = {
                    kabupaten: kabupaten,
                    nama: formData.get('nama'),
                    presensi: formData.get('presensi'),
                    fotoMimeType: fotoFile.type,
                    fotoBase64: base64Foto
                };
                
                // 5. Kirim ke Google Apps Script
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // GAS seringkali lebih suka text/plain untuk postData
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const tgl = new Date().toLocaleDateString('id-ID');
                    showStatus(`Sukses! Absensi '${payload.presensi}' atas nama '${payload.nama}' pada '${tgl}' telah dikirim.`, false);
                    form.reset(); // Reset form
                    selectNama.innerHTML = '<option value="">-- Pilih Kabupaten Dulu --</option>';
                    selectNama.disabled = true;
                    // Biarkan tombol disable untuk mencegah duplikat (sesuai permintaan "kunci 1x")
                    kirimBtn.textContent = 'Terkirim!';
                } else {
                    // Tampilkan pesan error dari backend (cth: duplikat)
                    throw new Error(result.error || 'Terjadi kesalahan di server.');
                }

            } catch (error) {
                showStatus(error.message, true);
                kirimBtn.disabled = false; // Aktifkan lagi tombol jika error
                kirimBtn.textContent = 'Kirim Absensi';
            } finally {
                hideLoading();
            }
        });

        // =================================================================
        // FUNGSI HELPER
        // =================================================================

        /**
         * Mendapatkan lokasi GPS (Promise-based)
         */
        function getGeoLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation tidak didukung oleh browser Anda.'));
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve(position),
                    (error) => {
                        let errorMsg = 'Gagal mendapatkan lokasi GPS. ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg += "Anda menolak izin lokasi.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg += "Informasi lokasi tidak tersedia.";
                                break;
                            case error.TIMEOUT:
                                errorMsg += "Waktu tunggu permintaan lokasi habis.";
                                break;
                            default:
                                errorMsg += "Terjadi error tidak diketahui.";
                        }
                        reject(new Error(errorMsg));
                    },
                    { 
                        enableHighAccuracy: true, // Minta akurasi tinggi
                        timeout: 10000, // Waktu tunggu 10 detik
                        maximumAge: 0 // Paksa ambil lokasi baru
                    }
                );
            });
        }

        /**
         * Menghitung jarak antara 2 titik lat/lng dalam METER
         * (Formula Haversine)
         */
        function getDistance(lat1, lng1, lat2, lng2) {
            function toRad(x) {
                return x * Math.PI / 180;
            }
            const R = 6371000; // Radius bumi dalam meter
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lng2 - lng1);
            lat1 = toRad(lat1);
            lat2 = toRad(lat2);

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            return d; // Jarak dalam meter
        }

        /**
         * Mengubah File foto menjadi string Base64
         */
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });
        }

    </script>
</body>
</html>
