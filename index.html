<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Bawaslu Riau</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            text-align: center;
        }
        #loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Preview Foto */
        #photo-preview {
            max-width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px dashed #d1d5db;
            margin-top: 1rem;
            background-color: #f9fafb;
        }
        /* Notifikasi */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 10000;
            font-weight: 500;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.show { display: block; opacity: 1; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="w-full max-w-lg p-6 mx-4 bg-white rounded-lg shadow-xl">
        <h1 class="text-2xl font-bold text-center text-gray-800">
            Selamat Datang di Aplikasi Absensi
        </h1>
        <h2 class="text-xl font-semibold text-center text-gray-600 mb-6">
            Bawaslu Provinsi Riau
        </h2>

        <form id="absensi-form" class="space-y-4">
            <!-- 1. Pilih Kabupaten -->
            <div>
                <label for="kabupaten" class="block text-sm font-medium text-gray-700">Pilih Kabupaten/Kota</label>
                <select id="kabupaten" name="kabupaten" required
                        class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="" disabled selected>-- Pilih Kabupaten --</option>
                    <!-- Options diisi oleh JS -->
                </select>
            </div>

            <!-- 2. Pilih Nama Pimpinan -->
            <div>
                <label for="nama-pimpinan" class="block text-sm font-medium text-gray-700">Nama Pimpinan</label>
                <select id="nama-pimpinan" name="nama-pimpinan" required
                        class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        disabled>
                    <option value="" disabled selected>-- Pilih Kabupaten Terlebih Dahulu --</option>
                </select>
            </div>

            <!-- 3. Jenis Presensi -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Jenis Presensi</label>
                <div class="flex gap-4 mt-2">
                    <label class="flex items-center">
                        <input type="radio" name="jenis-presensi" value="Masuk" class="text-blue-600 focus:ring-blue-500" required>
                        <span class="ml-2 text-gray-700">Presensi Masuk</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="jenis-presensi" value="Pulang" class="text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-gray-700">Presensi Pulang</span>
                    </label>
                </div>
            </div>

            <!-- 4. Upload Foto Selfie -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Foto Selfie (Wajib)</label>
                <p class="text-xs text-gray-500">Aplikasi akan membuka kamera. Tidak bisa upload dari galeri.</p>
                <input type="file" id="foto-selfie" name="foto-selfie" accept="image/*" capture="user" required
                       class="w-full px-3 py-2 mt-1 text-sm text-gray-700 border border-gray-300 rounded-md file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <img id="photo-preview" src="https://placehold.co/400x200/f9fafb/d1d5db?text=Preview+Foto" alt="Preview Foto"/>
            </div>

            <!-- 5. Tombol Kirim -->
            <button type="submit" id="submit-button"
                    class="w-full px-4 py-3 font-bold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 flex items-center justify-center">
                Kirim Absensi
            </button>
        </form>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div id="loading-spinner"></div>
        <p id="loading-text" class="mt-4 text-lg">Memproses...</p>
    </div>

    <!-- Notifikasi -->
    <div id="notification-popup" class="notification"></div>

    <script>
        // =======================================================================
        // PENTING: GANTI URL INI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA
        // (Gunakan URL yang SAMA dengan admin dashboard)
        // =======================================================================
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxtXPppk8KrQrmKJ6fWz077LwWojRtI-keKOErfjoxpGSeEvL8vuPgoDwV7uSntL0fX/exec';
        // =======================================================================


        // --- DATA MASTER ---
        const pimpinanData = {
            "Pekanbaru": ["Ferdy", "Misbah Ibrahim", "Reni Purba", "Raja Inal Dalimunthe", "Taufik Hidayat"],
            "Dumai": ["Agustri", "Yosi Renaldi", "Yeni Kartini"],
            "Kuansing": ["Ade Indra Sakti", "Nur Afni", "Mardius Adi Saputra"],
            "Rokan Hulu": ["Fajrul Islami Damsir", "Gummer Siregar", "Yurnalis", "Wikki Yuliandra", "Safrizal Hasbi"],
            "Rokan Hilir": ["Zubaidah", "Jaka Abdillah", "Nasrudin", "Dedi Sibuae", "Nurmaidani"],
            "Indragiri Hulu": ["Dedi Risanto", "Dwi Apriansyah Indra", "M.Lukman Said", "Said M Affandi", "Salestia Deni"],
            "Indragiri Hilir": ["Rustam", "Rahmaddian", "Abus Siraj", "Indra", "Musdalifa"],
            "Kampar": ["Syawir Abdullah", "Miki AB", "Mustaqim Akbar", "Fadriansyah", "Mhd. Amin S"],
            "Siak": ["Zulfadli Nugraha", "Ahmad Dardiri", "Harlen Manurung", "M.Andi Susilawan", "Ikhsan Parulian Harap"],
            "Bengkalis": ["Usman", "Budi Kurnialis", "Andi Setiawan", "Arsi Suprianto", "Mendra"],
            "Kep.Meranti": ["Syamsurizal", "Rio Andika", "M. Hafit"],
            "Pelalawan": ["Andrizal", "Bambang Sugi Hartono", "Syakir Hamdani", "Ari Nugroho Susanto", "Ruda Nur Kisawan"]
        };

        const targetCoordinates = {
            "Pekanbaru": { lat: 0.5228952, lon: 101.4429202 },
            "Dumai": { lat: 1.6630254508232711, lon: 101.45249334765391 },
            "Kuansing": { lat: -0.534470, lon: 101.569874 },
            "Rokan Hulu": { lat: 0.876158, lon: 100.286686 },
            "Rokan Hilir": { lat: 2.158803, lon: 100.799874 },
            "Indragiri Hulu": { lat: 2.158803, lon: 100.799874 }, // Data sama dengan Rohil?
            "Indragiri Hilir": { lat: -0.3201440, lon: 103.1542940 },
            "Kampar": { lat: 0.324784, lon: 101.026305 },
            "Siak": { lat: 0.814464, lon: 102.018998 },
            "Bengkalis": { lat: 1.473969, lon: 102.123841 },
            "Kep.Meranti": { lat: 1.008499, lon: 102.712468 },
            "Pelalawan": { lat: 2.158803, lon: 100.799874 } // Data sama dengan Rohil?
        };

        // --- ELEMEN DOM ---
        const form = document.getElementById('absensi-form');
        const kabSelect = document.getElementById('kabupaten');
        const namaSelect = document.getElementById('nama-pimpinan');
        const fotoInput = document.getElementById('foto-selfie');
        const fotoPreview = document.getElementById('photo-preview');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const submitButton = document.getElementById('submit-button');

        // --- FUNGSI TAMPILAN ---
        function showLoading(text) {
            loadingText.textContent = text;
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
            loadingOverlay.style.display = 'none';
        }

        function showNotification(message, type = 'success') {
            const popup = document.getElementById('notification-popup');
            popup.textContent = message;
            popup.className = `notification ${type} show`;
            
            setTimeout(() => {
                popup.style.opacity = '0';
                setTimeout(() => {
                    popup.classList.remove('show');
                }, 500);
            }, 3000);
        }

        // --- FUNGSI INISIALISASI ---
        function populateKabupaten() {
            Object.keys(pimpinanData).forEach(kab => {
                const option = document.createElement('option');
                option.value = kab;
                option.textContent = kab;
                kabSelect.appendChild(option);
            });
        }

        // --- EVENT LISTENERS ---
        kabSelect.addEventListener('change', () => {
            const selectedKab = kabSelect.value;
            const pimpinan = pimpinanData[selectedKab];

            namaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Nama --</option>'; // Reset
            
            if (pimpinan) {
                pimpinan.forEach(nama => {
                    const option = document.createElement('option');
                    option.value = nama;
                    option.textContent = nama;
                    namaSelect.appendChild(option);
                });
                namaSelect.disabled = false;
            } else {
                namaSelect.disabled = true;
            }
        });

        fotoInput.addEventListener('change', () => {
            const file = fotoInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    fotoPreview.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        form.addEventListener('submit', handleFormSubmit);

        // --- FUNGSI UTAMA ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            submitButton.disabled = true;

            const formData = new FormData(form);
            const kabupaten = formData.get('kabupaten');
            const nama = formData.get('nama-pimpinan');
            const jenisPresensi = formData.get('jenis-presensi');
            const fotoFile = formData.get('foto-selfie');
            const timestamp = new Date().toISOString();
            
            // 1. Validasi Form (Nama dan Jenis Presensi)
            if (!kabupaten || !nama || !jenisPresensi) {
                showNotification("Harap lengkapi semua data (Kabupaten, Nama, Jenis Presensi).", "error");
                submitButton.disabled = false;
                return;
            }
            
            // 2. Validasi Foto
            if (!fotoFile || fotoFile.size === 0) {
                showNotification("Harap ambil foto selfie.", "error");
                submitButton.disabled = false;
                return;
            }

            // 3. Cek Kecurangan Sisi Klien (localStorage)
            const today = new Date().toISOString().split('T')[0];
            const storageKey = `absensi_${nama}_${jenisPresensi}_${today}`;
            
            if (localStorage.getItem(storageKey)) {
                showNotification("Anda terdeteksi melakukan absensi berulang pada perangkat yang sama.", "error");
                submitButton.disabled = false;
                return;
            }

            // --- Mulai Proses Absensi ---
            showLoading("Mendapatkan lokasi GPS Anda...");

            try {
                // 4. Cek Lokasi GPS
                const userCoords = await getGpsCoords();
                const target = targetCoordinates[kabupaten];
                
                if (!target) {
                    throw new Error("Data koordinat untuk kabupaten Anda tidak ditemukan.");
                }

                const distance = haversineDistance(userCoords, target);
                const distanceInMeters = distance.toFixed(0);

                if (distance > 100) { // Batas 100 meter
                    throw new Error(`Anda saat ini tidak dapat melakukan absensi karena berada ${distanceInMeters} meter dari titik lokasi kantor.`);
                }
                
                // 5. Konversi Foto ke Base64
                showLoading("Mengupload foto Anda...");
                const fotoBase64 = await fileToBase64(fotoFile);

                // 6. Kirim data ke Google Apps Script
                const payload = {
                    kabupaten,
                    nama,
                    jenisPresensi,
                    fotoBase64,
                    timestamp
                };

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Kirim sebagai text/plain untuk di-parse GAS
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.status === "success") {
                    // 7. Sukses
                    localStorage.setItem(storageKey, 'true'); // Tandai sudah absen
                    showNotification(result.message, "success");
                    form.reset(); // Kosongkan form
                    fotoPreview.src = 'https://placehold.co/400x200/f9fafb/d1d5db?text=Preview+Foto';
                } else {
                    // 8. Gagal (Error dari server, misal: sudah absen)
                    throw new Error(result.message || "Terjadi error di server.");
                }

            } catch (error) {
                console.error("Error submitting attendance:", error);
                showNotification(error.message, "error");
            } finally {
                hideLoading();
                submitButton.disabled = false;
            }
        }

        // --- FUNGSI HELPER ---

        // Promise untuk mendapatkan koordinat GPS
        function getGpsCoords() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Browser Anda tidak mendukung Geolocation."));
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        });
                    },
                    (error) => {
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                reject(new Error("Anda menolak izin lokasi GPS."));
                                break;
                            case error.POSITION_UNAVAILABLE:
                                reject(new Error("Informasi lokasi tidak tersedia."));
                                break;
                            case error.TIMEOUT:
                                reject(new Error("Waktu tunggu mendapatkan lokasi habis."));
                                break;
                            default:
                                reject(new Error("Gagal mendapatkan lokasi GPS."));
                                break;
                        }
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        // Rumus Haversine untuk menghitung jarak
        function haversineDistance(coords1, coords2) {
            function toRad(x) {
                return x * Math.PI / 180;
            }
            const R = 6371; // Radius bumi dalam km
            const dLat = toRad(coords2.lat - coords1.lat);
            const dLon = toRad(coords2.lon - coords1.lon);
            const lat1 = toRad(coords1.lat);
            const lat2 = toRad(coords2.lat);

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            
            return d * 1000; // Kembalikan dalam meter
        }
        
        // Konversi file ke Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });
        }
        
        // Panggil inisialisasi
        populateKabupaten();

    </script>
</body>
</html>
